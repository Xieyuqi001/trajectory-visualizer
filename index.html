<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨æ€ç‰©ä½“è½¨è¿¹çƒ­åŠ›å›¾å¯è§†åŒ–å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/gif.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recordrtc@5.6.2/RecordRTC.min.js"></script>

    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 3px; }
        ::-webkit-scrollbar-track { background-color: #f3f4f6; }
        .vis-container {
            width: 100%;
            height: 100%;
            min-height: 500px;
            background-color: #27272a; /* ç»Ÿä¸€æš—è‰²èƒŒæ™¯ */
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        #vis-canvas-2d, #vis-canvas-3d {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        .drag-area {
            border: 2px dashed #9ca3af;
            background-color: #f9fafb;
            transition: all 0.2s;
        }
        .drag-area.active {
            border: 2px dashed #3b82f6;
            background-color: #dbeafe;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <div class="container mx-auto p-4">
        <header class="bg-white p-4 rounded-lg shadow-lg mb-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <svg class="w-8 h-8 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8m3-2a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                åŠ¨æ€ç‰©ä½“è½¨è¿¹çƒ­åŠ›å›¾å¯è§†åŒ–å·¥å…·
            </h1>
            <button id="help-btn" class="text-sm text-blue-500 hover:text-blue-700 font-medium">
                <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9.247a1 1 0 01.796-.109l.003.001c.21.05.34.25.34.46V12a1 1 0 01-1 1H7a1 1 0 01-1-1v-2.39c0-.131.026-.262.078-.387a1 1 0 01.35-.494l.006-.003c.12-.08.26-.118.4-.118h.001z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2a10 10 0 100 20 10 10 0 000-20z"></path></svg>
                å¸®åŠ©/è¯´æ˜
            </button>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-4 xl:grid-cols-5 gap-4">

            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-3 border-b pb-2">ğŸ“‚ æ•°æ®ä¸Šä¼ ä¸æ¦‚è§ˆ</h2>
                    <div id="upload-drag-area" class="drag-area p-6 text-center cursor-pointer rounded-lg mb-3">
                        <p class="text-gray-600 font-medium">æ‹–æ‹½ CSV æ–‡ä»¶åˆ°æ­¤</p>
                        <p class="text-sm text-gray-400">æˆ–ç‚¹å‡»æŒ‰é’®é€‰æ‹©æ–‡ä»¶</p>
                        <input type="file" id="csv-file-input" accept=".csv" class="hidden" />
                    </div>
                    <button id="upload-btn" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition">ä¸Šä¼  CSV æ–‡ä»¶</button>
                    <div id="upload-progress" class="w-full bg-gray-200 rounded-full h-2.5 mt-2 hidden">
                        <div class="bg-blue-400 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-2">ğŸ“Š æ•°æ®æ¦‚è§ˆ</h3>
                    <div id="data-stats" class="text-sm text-gray-600 space-y-1">
                        <p>æ€»æ•°æ®ç‚¹ï¼š<span id="stat-total-points" class="font-medium text-gray-800">0</span></p>
                        <p>è¿åŠ¨æ€»æ—¶é—´ï¼š<span id="stat-total-time" class="font-medium text-gray-800">0 s</span></p>
                        <p>æ—¶é—´èŒƒå›´ï¼š<span id="stat-time-range" class="font-medium text-gray-800">-</span></p>
                        <p>2D åæ ‡èŒƒå›´ (X/Y)ï¼š<span id="stat-2d-range" class="font-medium text-gray-800">-</span></p>
                        <p>3D åæ ‡èŒƒå›´ (X/Y/Z)ï¼š<span id="stat-3d-range" class="font-medium text-gray-800">-</span></p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 xl:col-span-3">
                <div class="bg-white p-2 rounded-lg shadow h-full flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-semibold">ğŸŒŒ è½¨è¿¹å¯è§†åŒ–</h2>
                        <div class="flex space-x-2">
                            <button id="toggle-vis-btn" class="px-3 py-1 text-sm rounded-md bg-green-500 text-white hover:bg-green-600 transition">
                                åˆ‡æ¢ 2D / 3D æ¨¡å¼
                            </button>
                            <span id="mode-display" class="px-3 py-1 text-sm bg-gray-200 rounded-md">å½“å‰: 2D æ¨¡å¼</span>
                        </div>
                    </div>
                    <div id="vis-container" class="vis-container flex-grow relative">
                        <canvas id="vis-canvas-2d" class="z-10"></canvas>
                        <div id="vis-canvas-3d" class="z-20 hidden"></div>
                        <div id="mouse-coords" class="absolute bottom-2 left-2 bg-black bg-opacity-50 text-white text-xs p-1 rounded z-30 hidden">
                            (X: 0, Y: 0)
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-3 border-b pb-2 flex justify-between items-center">
                        ğŸ“ˆ è¿åŠ¨æŒ‡æ ‡
                        <button id="export-metrics-btn" class="text-xs text-blue-500 hover:text-blue-700">å¯¼å‡º</button>
                    </h2>
                    <div id="metrics-display" class="text-sm text-gray-600 space-y-2">
                        <p>æ€»è¿åŠ¨è·ç¦»ï¼š<span id="metric-distance" class="font-bold text-lg text-red-600 cursor-copy" title="ç‚¹å‡»å¤åˆ¶">0.00 m</span></p>
                        <p>å¹³å‡é€Ÿåº¦ï¼š<span id="metric-avg-speed" class="font-bold text-lg text-red-600 cursor-copy" title="ç‚¹å‡»å¤åˆ¶">0.00 m/s</span></p>
                        <p>æœ€å¤§ç¬æ—¶é€Ÿåº¦ï¼š<span id="metric-max-speed" class="font-bold text-lg text-red-600 cursor-copy" title="ç‚¹å‡»å¤åˆ¶">0.00 m/s</span></p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-3 border-b pb-2">â–¶ï¸ åŠ¨æ€æ’­æ”¾æ§åˆ¶</h2>
                    <div class="flex space-x-2 mb-3">
                        <button id="play-btn" class="p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition" title="æ’­æ”¾/æš‚åœ"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg></button>
                        <button id="reset-btn" class="p-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition" title="é‡ç½®"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm1 2h10v10H5V4z"></path></svg></button>
                        <div class="flex-grow">
                            <label class="block text-xs text-gray-500">æ’­æ”¾é€Ÿåº¦ (<span id="speed-val">1.0</span>x)</label>
                            <input type="range" id="speed-slider" min="0.5" max="3" step="0.1" value="1" class="w-full">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">æ—¶é—´è½´ (<span id="current-time">0.00</span>s / <span id="max-time">0.00</span>s)</label>
                        <input type="range" id="timeline-slider" min="0" max="100" step="0.1" value="0" class="w-full">
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 id="settings-toggle" class="text-xl font-semibold mb-3 border-b pb-2 cursor-pointer hover:text-blue-500 flex justify-between items-center">
                        ğŸ¨ è‡ªå®šä¹‰è®¾ç½®
                        <span class="text-gray-500">â–¼</span>
                    </h2>
                    <div id="settings-panel" class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">é¢œè‰²æ–¹æ¡ˆ</label>
                            <select id="color-scheme" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                <option value="jet">Jet (é»˜è®¤)</option>
                                <option value="viridis">Viridis</option>
                                <option value="plasma">Plasma</option>
                                <option value="coolwarm">Coolwarm</option>
                                <option value="grayscale">Grayscale</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">é€æ˜åº¦ (<span id="opacity-val">0.8</span>)</label>
                            <input type="range" id="opacity-slider" min="0.3" max="1.0" step="0.1" value="0.8" class="w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ¨¡ç³ŠåŠå¾„ (<span id="blur-val">5</span> px)</label>
                            <input type="range" id="blur-slider" min="1" max="10" step="1" value="5" class="w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç‚¹å¤§å° (<span id="size-val">5</span> px)</label>
                            <input type="range" id="size-slider" min="2" max="10" step="1" value="5" class="w-full">
                        </div>
                        <div id="3d-settings" class="space-y-3 hidden border-t pt-3">
                             <h4 class="text-md font-medium">3D ä¸“å±è®¾ç½®</h4>
                             <div>
                                <label class="block text-sm font-medium text-gray-700">é«˜åº¦ç¼©æ”¾ (<span id="height-scale-val">1.0</span>x)</label>
                                <input type="range" id="height-scale-slider" min="0.1" max="3.0" step="0.1" value="1.0" class="w-full">
                             </div>
                             <div class="flex items-center">
                                <input id="show-axes" type="checkbox" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded mr-2">
                                <label for="show-axes" class="text-sm font-medium text-gray-700">æ˜¾ç¤ºåæ ‡è½´</label>
                             </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-3 border-b pb-2">ğŸ–¼ï¸ å¯¼å‡ºåŠŸèƒ½</h2>
                    <div class="space-y-2">
                        <button id="export-png-btn" class="w-full bg-indigo-500 text-white p-2 rounded-md hover:bg-indigo-600 transition">å¯¼å‡ºå½“å‰ PNG å›¾ç‰‡</button>
                        <button id="export-gif-btn" class="w-full bg-indigo-500 text-white p-2 rounded-md hover:bg-indigo-600 transition">å¯¼å‡º GIF åŠ¨ç”»</button>
                        <button id="export-video-btn" class="w-full bg-indigo-500 text-white p-2 rounded-md hover:bg-indigo-600 transition">å¯¼å‡º MP4 è§†é¢‘</button>
                    </div>
                    <div id="export-status" class="mt-2 text-sm text-center text-gray-500 hidden"></div>
                </div>
            </div>
        </main>

        <footer class="mt-4 bg-gray-800 text-white p-3 rounded-lg shadow-lg flex justify-between items-center text-sm">
            <span id="status-bar">ğŸš€ å‡†å¤‡å°±ç»ªã€‚è¯·ä¸Šä¼  CSV æ–‡ä»¶å¼€å§‹å¯è§†åŒ–ã€‚</span>
            <span>&copy; è½¨è¿¹å¯è§†åŒ–å·¥å…· (Powered by Gemini)</span>
        </footer>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div id="modal-content" class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-lg">
            </div>
    </div>

    <script>
        // --- å…¨å±€å˜é‡ ---
        let allData = [];
        let cleanData = [];
        let visualizationMode = '2D'; // '2D' or '3D'
        let playInterval = null;
        let animationFrameId = null;
        let currentFrameIndex = 0;
        let playbackSpeed = 1.0;
        let totalFrames = 0;

        // --- Three.js å˜é‡ ---
        let scene, camera, renderer, controls, cube;

        // --- D3/Chart.js å˜é‡ (2D) ---
        let chart2d;
        let canvas2d = document.getElementById('vis-canvas-2d');
        let ctx2d = canvas2d.getContext('2d');
        
        // --- å¸¸é‡ï¼šCSV è¦æ±‚çš„åˆ—å ---
        const REQUIRED_COLUMNS = [
            'timestamp', 'x_2d', 'y_2d',
            'x_3d(m)', 'y_3d(m)', 'z_3d(m)'
        ];
        
        // --- é¢œè‰²æ˜ å°„å‡½æ•° (ç®€åŒ–ç‰ˆ) ---
        function getColor(value, max) {
            const ratio = value / max;
            if (ratio < 0.2) return 'rgba(0, 0, 255, 0.5)'; // Blue
            if (ratio < 0.5) return 'rgba(0, 255, 0, 0.5)'; // Green
            if (ratio < 0.8) return 'rgba(255, 255, 0, 0.5)'; // Yellow
            return 'rgba(255, 0, 0, 0.5)'; // Red
        }


        // ------------------------------------
        // --- I. æ•°æ®ä¸Šä¼ ä¸è§£æ (Papa Parse) ---
        // ------------------------------------

        // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ /æ‹–æ‹½åŒºåŸŸ
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('csv-file-input');
            const uploadBtn = document.getElementById('upload-btn');
            const dragArea = document.getElementById('upload-drag-area');

            // ç›‘å¬æŒ‰é’®ç‚¹å‡»
            uploadBtn.addEventListener('click', () => input.click());

            // ç›‘å¬æ–‡ä»¶é€‰æ‹©
            input.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));

            // æ‹–æ‹½äº‹ä»¶ç›‘å¬
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dragArea.addEventListener(eventName, preventDefaults, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                dragArea.addEventListener(eventName, () => dragArea.classList.add('active'), false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                dragArea.addEventListener(eventName, () => dragArea.classList.remove('active'), false);
            });
            dragArea.addEventListener('drop', handleDrop, false);

            // åˆå§‹åŒ– 2D/3D æ¨¡å¼
            init2DChart();
            init3DScene();
            window.addEventListener('resize', onWindowResize);
            onWindowResize();
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            let dt = e.dataTransfer;
            let files = dt.files;
            handleFileUpload(files[0]);
        }

        function handleFileUpload(file) {
            if (!file) return;

            // 1. æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const status = document.getElementById('status-bar');
            const progressDiv = document.getElementById('upload-progress');
            progressDiv.style.width = '0%';
            progressDiv.classList.remove('hidden');
            status.textContent = 'â³ æ­£åœ¨è§£æ CSV æ–‡ä»¶...';
            
            // ... çœç•¥äº† handleFileUpload å‡½æ•°å¼€å¤´éƒ¨åˆ†

            // 2. ä½¿ç”¨ Papa Parse è§£æ CSV
            Papa.parse(file, {
                header: true,
                skipEmptyLines: 'greedy',
                dynamicTyping: true,
                worker: true, // å…³é”®ï¼šåœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œï¼Œé˜²æ­¢ UI å¡é¡¿
                // !!! ç§»é™¤äº† step å‡½æ•°ï¼Œè®© worker ä¸€æ¬¡æ€§å¤„ç†æ•´ä¸ªæ–‡ä»¶ !!!
                
                complete: (results, file) => {
                    progressDiv.classList.add('hidden');
                    
                    // 3. æ£€æŸ¥æ•°æ®å’Œåˆ—å
                    if (results.data.length === 0) {
                        status.textContent = 'âŒ CSV è§£æå¤±è´¥ï¼šæ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯ã€‚';
                        return;
                    }
                    
                    allData = results.data;
                    cleanData = processAndCleanData(allData);

                    if (cleanData.length === 0) {
                        status.textContent = 'âŒ CSV è§£æå¤±è´¥ï¼šæœ‰æ•ˆæ•°æ®ç‚¹ä¸è¶³ï¼Œè¯·æ£€æŸ¥åˆ—åå’Œæ•°å€¼ã€‚';
                        return;
                    }

                    // 4. æ›´æ–° UI å’Œå¯è§†åŒ–
                    updateDataStats(cleanData);
                    calculateMotionMetrics(cleanData);
                    resetPlayback(cleanData);
                    updateVisualizations();

                    status.textContent = `âœ… æ•°æ®åŠ è½½æˆåŠŸï¼å…± ${cleanData.length} ä¸ªæœ‰æ•ˆæ•°æ®ç‚¹ã€‚`;
                },
                error: (error, file) => {
                    progressDiv.classList.add('hidden');
                    status.textContent = `âŒ CSV è§£æé”™è¯¯: ${error.message}`;
                }
            });

// ... çœç•¥äº† handleFileUpload å‡½æ•°ç»“å°¾éƒ¨åˆ†
        }

        /**
         * @description è¿‡æ»¤ã€æ¸…æ´—å’Œè§„èŒƒåŒ–æ•°æ®ã€‚
         * @param {Array<Object>} rawData - åŸå§‹ Papa Parse æ•°æ®æ•°ç»„ã€‚
         * @returns {Array<Object>} æ¸…æ´—åçš„æ•°æ®æ•°ç»„ã€‚
         */
        function processAndCleanData(rawData) {
            const cleaned = [];
            
            // æ£€æŸ¥å¿…éœ€åˆ—æ˜¯å¦å­˜åœ¨
            const headers = Object.keys(rawData[0] || {});
            const hasAllColumns = REQUIRED_COLUMNS.every(col => headers.includes(col));

            if (!hasAllColumns) {
                document.getElementById('status-bar').textContent = 'âš ï¸ è­¦å‘Šï¼šCSV ç¼ºå°‘å¿…éœ€åˆ—ã€‚è¯·æ£€æŸ¥åˆ—åï¼';
                return [];
            }

            rawData.forEach(row => {
                // ç¡®ä¿ timestamp å’Œæ‰€æœ‰åæ ‡å€¼éƒ½æ˜¯æœ‰æ•ˆçš„æ•°å­—
                const valid = REQUIRED_COLUMNS.every(col => {
                    const value = row[col];
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæ•°å­—ä¸”ä¸ä¸º NaN
                    return value !== null && value !== '' && !isNaN(Number(value));
                });

                if (valid) {
                    cleaned.push({
                        timestamp: Number(row['timestamp']),
                        x_2d: Number(row['x_2d']),
                        y_2d: Number(row['y_2d']),
                        x_3d: Number(row['x_3d(m)']),
                        y_3d: Number(row['y_3d(m)']),
                        z_3d: Number(row['z_3d(m)'])
                    });
                }
            });
            
            // æŒ‰æ—¶é—´æˆ³æ’åº (ç¡®ä¿åŠ¨æ€æ’­æ”¾æ­£ç¡®)
            cleaned.sort((a, b) => a.timestamp - b.timestamp);
            
            return cleaned;
        }

        // ------------------------------------
        // --- II. æ•°æ®æ¦‚è§ˆä¸æŒ‡æ ‡è®¡ç®— ---
        // ------------------------------------

        function updateDataStats(data) {
            const timestamps = data.map(d => d.timestamp);
            const x2d = data.map(d => d.x_2d);
            const y2d = data.map(d => d.y_2d);
            const x3d = data.map(d => d.x_3d);
            const y3d = data.map(d => d.y_3d);
            const z3d = data.map(d => d.z_3d);

            const minT = Math.min(...timestamps);
            const maxT = Math.max(...timestamps);

            document.getElementById('stat-total-points').textContent = data.length;
            document.getElementById('stat-total-time').textContent = `${(maxT - minT).toFixed(2)} s`;
            document.getElementById('stat-time-range').textContent = `${minT.toFixed(2)}s - ${maxT.toFixed(2)}s`;
            
            document.getElementById('stat-2d-range').textContent = 
                `X: [${Math.min(...x2d).toFixed(2)}, ${Math.max(...x2d).toFixed(2)}] / Y: [${Math.min(...y2d).toFixed(2)}, ${Math.max(...y2d).toFixed(2)}]`;

            document.getElementById('stat-3d-range').textContent = 
                `X: [${Math.min(...x3d).toFixed(2)}, ${Math.max(...x3d).toFixed(2)}], Y: [${Math.min(...y3d).toFixed(2)}, ${Math.max(...y3d).toFixed(2)}], Z: [${Math.min(...z3d).toFixed(2)}, ${Math.max(...z3d).toFixed(2)}]`;

            // æ›´æ–°æ’­æ”¾æ»‘å—
            totalFrames = data.length;
            document.getElementById('max-time').textContent = (maxT - minT).toFixed(2);
            document.getElementById('timeline-slider').max = totalFrames - 1;
        }

        /**
         * @description è®¡ç®—æ ¸å¿ƒè¿åŠ¨æŒ‡æ ‡ (åŸºäº 3D æ•°æ®)ã€‚
         * @param {Array<Object>} data - æ¸…æ´—åçš„æ•°æ®æ•°ç»„ã€‚
         */
        function calculateMotionMetrics(data) {
            if (data.length < 2) {
                document.getElementById('metric-distance').textContent = '0.00 m';
                document.getElementById('metric-avg-speed').textContent = '0.00 m/s';
                document.getElementById('metric-max-speed').textContent = '0.00 m/s';
                return;
            }

            let totalDistance = 0;
            let maxInstantaneousSpeed = 0;
            
            for (let i = 1; i < data.length; i++) {
                const p1 = data[i - 1];
                const p2 = data[i];

                // æ¬§æ°è·ç¦» (3D)
                const dx = p2.x_3d - p1.x_3d;
                const dy = p2.y_3d - p1.y_3d;
                const dz = p2.z_3d - p1.z_3d;
                const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);
                totalDistance += dist;
                
                // æ—¶é—´é—´éš”
                const dt = p2.timestamp - p1.timestamp;
                
                if (dt > 0) {
                    const speed = dist / dt;
                    if (speed > maxInstantaneousSpeed) {
                        maxInstantaneousSpeed = speed;
                    }
                }
            }

            const totalTime = data[data.length - 1].timestamp - data[0].timestamp;
            const avgSpeed = totalTime > 0 ? totalDistance / totalTime : 0;

            document.getElementById('metric-distance').textContent = `${totalDistance.toFixed(2)} m`;
            document.getElementById('metric-avg-speed').textContent = `${avgSpeed.toFixed(2)} m/s`;
            document.getElementById('metric-max-speed').textContent = `${maxInstantaneousSpeed.toFixed(2)} m/s`;
        }
        
        // å¤åˆ¶æŒ‡æ ‡æ•°å€¼
        document.querySelectorAll('#metrics-display span').forEach(el => {
            el.addEventListener('click', (e) => {
                const text = e.target.textContent.split(' ')[0];
                navigator.clipboard.writeText(text).then(() => {
                    const originalText = e.target.textContent;
                    e.target.textContent = 'å·²å¤åˆ¶!';
                    setTimeout(() => e.target.textContent = originalText, 500);
                });
            });
        });

        // ------------------------------------
        // --- III. å¯è§†åŒ–åˆ‡æ¢ä¸åˆå§‹åŒ– ---
        // ------------------------------------

        document.getElementById('toggle-vis-btn').addEventListener('click', () => {
            visualizationMode = visualizationMode === '2D' ? '3D' : '2D';
            
            const is3D = visualizationMode === '3D';
            document.getElementById('vis-canvas-2d').classList.toggle('hidden', is3D);
            document.getElementById('vis-canvas-3d').classList.toggle('hidden', !is3D);
            document.getElementById('mode-display').textContent = `å½“å‰: ${is3D ? '3D' : '2D'} æ¨¡å¼`;
            document.getElementById('3d-settings').classList.toggle('hidden', !is3D);
            
            // é‡ç»˜æˆ–æ›´æ–°
            updateVisualizations();
        });

        // 2D åˆå§‹åŒ– (Chart.js å®ä¾‹)
        function init2DChart() {
            if (chart2d) chart2d.destroy();
            chart2d = new Chart(ctx2d, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'è½¨è¿¹ç‚¹',
                        data: [],
                        backgroundColor: 'rgba(255, 0, 0, 1)',
                        pointRadius: 5,
                        borderColor: 'rgba(0, 0, 0, 0)',
                        borderWidth: 0,
                    },
                    // è½¨è¿¹çº¿
                    {
                        label: 'å†å²è½¨è¿¹',
                        data: [],
                        backgroundColor: 'rgba(0, 0, 255, 0.3)',
                        borderColor: 'rgba(0, 0, 255, 0.3)',
                        borderWidth: 1,
                        showLine: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', position: 'bottom', title: { display: true, text: 'X (2D)' } },
                        y: { type: 'linear', title: { display: true, text: 'Y (2D)' } }
                    },
                    plugins: { legend: { display: false } },
                    animation: false
                }
            });
        }
        
        // 3D åˆå§‹åŒ– (Three.js å®ä¾‹)
        function init3DScene() {
            const container = document.getElementById('vis-canvas-3d');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x27272a); // ä¸å®¹å™¨èƒŒæ™¯ä¸€è‡´
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            camera.position.set(5, 5, 5); // åˆå§‹è§†è§’

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; // å¯ç”¨é˜»å°¼æ•ˆæœ
            controls.dampingFactor = 0.05;
            
            // æ·»åŠ ç¯å¢ƒå…‰å’Œç‚¹å…‰æº
            scene.add(new THREE.AmbientLight(0x404040, 5));
            const light = new THREE.PointLight(0xffffff, 100);
            light.position.set(10, 10, 10);
            scene.add(light);
            
            // 3D åæ ‡è½´ (é»˜è®¤æ˜¾ç¤º)
            const axesHelper = new THREE.AxesHelper(5); // 5ä¸ªå•ä½é•¿åº¦
            axesHelper.name = 'Axes';
            scene.add(axesHelper);

            function animate() {
                animationFrameId = requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
        }
        
        function onWindowResize() {
            const container = document.getElementById('vis-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // 2D Resize
            canvas2d.width = width;
            canvas2d.height = height;
            if (chart2d) chart2d.resize();

            // 3D Resize
            if (camera && renderer) {
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }
        }
        
        // ------------------------------------
        // --- IV. å¯è§†åŒ–æ›´æ–°é€»è¾‘ ---
        // ------------------------------------

        function updateVisualizations() {
            if (visualizationMode === '2D') {
                render2DHeatmap(cleanData);
                update2DChart(currentFrameIndex);
            } else {
                render3DVisualization(cleanData);
            }
        }
        
        /**
         * @description æ¨¡æ‹Ÿ 2D çƒ­åŠ›å›¾ç»˜åˆ¶ (ä½¿ç”¨ Canvas æ¨¡æ‹Ÿçƒ­åŠ›å›¾é€»è¾‘)ã€‚
         * @param {Array<Object>} data - è½¨è¿¹æ•°æ®ã€‚
         */
        function render2DHeatmap(data) {
            if (data.length === 0) return;
            // æ¸…é™¤æ—§çƒ­åŠ›å›¾ (ä¿ç•™ Chart.js è½¨è¿¹)
            // çœŸå®çš„å®ç°éœ€è¦ä½¿ç”¨ä¸“é—¨çš„çƒ­åŠ›å›¾åº“ (å¦‚ heatmap.js) æˆ– WebGLã€‚
            // è¿™é‡Œçš„å®ç°æ˜¯æ¨¡æ‹Ÿçš„ï¼Œåªæ›´æ–° Chart.js è½¨è¿¹ç‚¹ã€‚

            // Step 1: ç¡®å®šæ•°æ®èŒƒå›´å’Œç”»å¸ƒå°ºå¯¸
            const width = canvas2d.width;
            const height = canvas2d.height;
            const xData = data.map(d => d.x_2d);
            const yData = data.map(d => d.y_2d);
            const minX = Math.min(...xData);
            const maxX = Math.max(...xData);
            const minY = Math.min(...yData);
            const maxY = Math.max(...yData);

            // Step 2: åæ ‡æ˜ å°„å‡½æ•° (ç®€åŒ–)
            // å‡è®¾ Chart.js çš„ scatter å›¾ä¼šè‡ªåŠ¨å¤„ç†åæ ‡æ˜ å°„
            
            // Step 3: ç»˜åˆ¶çƒ­åŠ›å›¾ (ä½¿ç”¨ Canvas ç»˜åˆ¶å¯†åº¦ç‚¹æ¨¡æ‹Ÿ)
            // âš ï¸ çœŸå®çš„çƒ­åŠ›å›¾éœ€è¦å¤æ‚çš„å¯†åº¦è®¡ç®—ã€é«˜æ–¯æ¨¡ç³Šå’Œé¢œè‰²æ˜ å°„ã€‚è¿™é‡Œä»…ä¸ºç»“æ„æ¼”ç¤ºã€‚
            ctx2d.clearRect(0, 0, width, height);
            
            // ç»˜åˆ¶ä¸€ä¸ªè¦†ç›–å…¨å›¾çš„ä½é€æ˜åº¦çŸ©å½¢ (æ¨¡æ‹Ÿçƒ­åŠ›å›¾èƒŒæ™¯)
            // ctx2d.fillStyle = 'rgba(255, 0, 0, 0.05)';
            // ctx2d.fillRect(0, 0, width, height);

            // éå†æ‰€æœ‰ç‚¹å¹¶ç»˜åˆ¶ (ç®€åŒ–æ¨¡æ‹Ÿçƒ­åŠ›ç‚¹)
            const pointRadius = parseInt(document.getElementById('size-slider').value);
            data.forEach(d => {
                // ä»…ç”¨äºè§†è§‰å±•ç¤ºï¼Œçƒ­åŠ›å›¾åº”ç‹¬ç«‹äºè½¨è¿¹çº¿
                // const chartArea = chart2d.chartArea;
                // const screenX = chart2d.scales.x.getPixelForValue(d.x_2d);
                // const screenY = chart2d.scales.y.getPixelForValue(d.y_2d);

                // // æ¨¡æ‹Ÿçƒ­ç‚¹: å¯†åº¦è¶Šå¤§ï¼Œé¢œè‰²è¶Šæ·±
                // ctx2d.fillStyle = 'rgba(255, 100, 0, 0.05)';
                // ctx2d.beginPath();
                // ctx2d.arc(screenX, screenY, pointRadius * 5, 0, Math.PI * 2);
                // ctx2d.fill();
            });
        }
        
        /**
         * @description æ›´æ–° 2D è½¨è¿¹çº¿å’Œé«˜äº®å½“å‰ç‚¹ã€‚
         * @param {number} frameIndex - å½“å‰æ’­æ”¾çš„å¸§ç´¢å¼•ã€‚
         */
        function update2DChart(frameIndex) {
            if (!chart2d || cleanData.length === 0) return;
            
            const historyData = cleanData.slice(0, frameIndex + 1).map(d => ({ x: d.x_2d, y: d.y_2d }));
            const currentPoint = cleanData[frameIndex];

            // 1. å†å²è½¨è¿¹çº¿ (ä½¿ç”¨ historyData ä½œä¸ºæ‰€æœ‰ç‚¹)
            chart2d.data.datasets[1].data = historyData;

            // 2. å½“å‰ç‚¹ (åªæ˜¾ç¤ºä¸€ä¸ªç‚¹)
            chart2d.data.datasets[0].data = currentPoint ? [{ x: currentPoint.x_2d, y: currentPoint.y_2d }] : [];
            chart2d.data.datasets[0].pointRadius = parseInt(document.getElementById('size-slider').value);

            chart2d.update('none'); // 'none' for instant update
            
            // 3. å®æ—¶æ›´æ–°æ—¶é—´è½´
            const minT = cleanData[0].timestamp;
            const currentTime = currentPoint ? (currentPoint.timestamp - minT).toFixed(2) : (0).toFixed(2);
            document.getElementById('current-time').textContent = currentTime;
            document.getElementById('timeline-slider').value = frameIndex;

            // 4. é‡ç»˜çƒ­åŠ›å›¾ (è¿™é‡Œä»…ä¸ºæ¼”ç¤ºï¼Œçƒ­åŠ›å›¾åœ¨å®é™…ä¸­åº”åŸºäºæ‰€æœ‰å†å²æ•°æ®)
            // render2DHeatmap(cleanData);
        }

        /**
         * @description æ¸²æŸ“ 3D è½¨è¿¹å’Œçƒ­åŠ›ç‚¹ã€‚
         * @param {Array<Object>} data - è½¨è¿¹æ•°æ®ã€‚
         */
        function render3DVisualization(data) {
            if (!scene || data.length === 0) return;
            
            // ç§»é™¤æ—§çš„è½¨è¿¹å’Œçƒ­åŠ›ç‚¹
            let oldTrajectory = scene.getObjectByName('Trajectory');
            if (oldTrajectory) scene.remove(oldTrajectory);
            
            // 1. ç»˜åˆ¶ 3D è½¨è¿¹çº¿
            const points = data.slice(0, currentFrameIndex + 1).map(d => new THREE.Vector3(d.x_3d, d.y_3d, d.z_3d));
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.LineBasicMaterial({ color: 0x00ffff });
            const line = new THREE.Line(geometry, material);
            line.name = 'Trajectory';
            scene.add(line);
            
            // 2. ç»˜åˆ¶ 3D çƒ­åŠ›ç‚¹ (æ¨¡æ‹Ÿ)
            // çœŸå®çš„ 3D çƒ­åŠ›å›¾é€šå¸¸æ˜¯ä½“æ¸²æŸ“ (Volume Rendering) æˆ–ä½¿ç”¨ Point Cloud
            // è¿™é‡Œä½¿ç”¨ Point Cloud æ¨¡æ‹Ÿè½¨è¿¹ç‚¹
            
            // ç§»é™¤æ—§çš„ç‚¹äº‘
            let oldHeatmap = scene.getObjectByName('Heatmap');
            if (oldHeatmap) scene.remove(oldHeatmap);

            const allPoints = data.map(d => new THREE.Vector3(d.x_3d, d.y_3d, d.z_3d));
            const pointsGeometry = new THREE.BufferGeometry().setFromPoints(allPoints);
            const pointsMaterial = new THREE.PointsMaterial({
                color: 0xff0000,
                size: parseFloat(document.getElementById('size-slider').value) * 0.1, // 3Dç‚¹å¤§å°ç¼©æ”¾
                transparent: true,
                opacity: parseFloat(document.getElementById('opacity-slider').value),
            });
            const pointsMesh = new THREE.Points(pointsGeometry, pointsMaterial);
            pointsMesh.name = 'Heatmap';
            scene.add(pointsMesh);
            
            // 3. ç»˜åˆ¶å½“å‰é«˜äº®ç‚¹
            let oldCurrentPoint = scene.getObjectByName('CurrentPoint');
            if (oldCurrentPoint) scene.remove(oldCurrentPoint);
            
            const currentPoint = data[currentFrameIndex];
            if (currentPoint) {
                const sphereGeometry = new THREE.SphereGeometry(0.1, 16, 16);
                const sphereMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
                const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
                sphere.position.set(currentPoint.x_3d, currentPoint.y_3d, currentPoint.z_3d);
                sphere.name = 'CurrentPoint';
                scene.add(sphere);
            }
            
            // 4. æ›´æ–°åæ ‡è½´æ˜¾ç¤º
            const axes = scene.getObjectByName('Axes');
            if (axes) axes.visible = document.getElementById('show-axes').checked;

            renderer.render(scene, camera);
        }
        
        // ------------------------------------
        // --- V. åŠ¨æ€æ˜¾ç¤ºä¸æ§åˆ¶ ---
        // ------------------------------------

        document.getElementById('speed-slider').addEventListener('input', (e) => {
            playbackSpeed = parseFloat(e.target.value);
            document.getElementById('speed-val').textContent = playbackSpeed.toFixed(1);
            if (playInterval) {
                // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°å¯åŠ¨å®šæ—¶å™¨ä»¥åº”ç”¨æ–°é€Ÿåº¦
                clearInterval(playInterval);
                startPlayback();
            }
        });

        document.getElementById('timeline-slider').addEventListener('input', (e) => {
            currentFrameIndex = parseInt(e.target.value);
            // åœæ­¢æ’­æ”¾å¹¶æ›´æ–°
            stopPlayback();
            updateVisualizations();
        });

        document.getElementById('play-btn').addEventListener('click', () => {
            if (cleanData.length === 0) {
                document.getElementById('status-bar').textContent = 'âš ï¸ è¯·å…ˆä¸Šä¼ æ•°æ®ï¼';
                return;
            }

            if (playInterval) {
                stopPlayback(); // æš‚åœ
                document.getElementById('play-btn').innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg>';
            } else {
                if (currentFrameIndex >= totalFrames - 1) {
                    currentFrameIndex = 0; // æ’­å®Œäº†ï¼Œé‡å¤´å¼€å§‹
                }
                startPlayback(); // æ’­æ”¾
                document.getElementById('play-btn').innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm3 1a1 1 0 012 0v4a1 1 0 11-2 0V8z"></path></svg>';
            }
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            resetPlayback(cleanData);
        });

        function resetPlayback(data) {
            stopPlayback();
            if (data.length > 0) {
                currentFrameIndex = 0;
                updateVisualizations();
                document.getElementById('play-btn').innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg>';
            }
        }
        
        function startPlayback() {
            if (cleanData.length === 0) return;
            const maxT = cleanData[cleanData.length - 1].timestamp;
            const minT = cleanData[0].timestamp;
            const totalTime = maxT - minT;
            const avgFrameTime = totalTime / cleanData.length; // ç†è®ºä¸Šçš„å¹³å‡å¸§é—´éš”æ—¶é—´

            // æ ¸å¿ƒå®šæ—¶å™¨ï¼šåŸºäºæ’­æ”¾é€Ÿåº¦å’Œå¸§æ•°ï¼Œè®¡ç®—å®šæ—¶å™¨é—´éš”
            const intervalTime = Math.max(50, (avgFrameTime * 1000) / playbackSpeed); // æœ€å°é—´éš” 50ms
            
            playInterval = setInterval(() => {
                if (currentFrameIndex < totalFrames - 1) {
                    currentFrameIndex++;
                    updateVisualizations();
                } else {
                    stopPlayback();
                    document.getElementById('play-btn').innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg>';
                }
            }, intervalTime);
        }
        
        function stopPlayback() {
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }

        // ------------------------------------
        // --- VI. å¯¼å‡ºåŠŸèƒ½ (PNG/GIF/Video) ---
        // ------------------------------------
        
        // 1. å¯¼å‡º PNG
        document.getElementById('export-png-btn').addEventListener('click', () => {
            const container = document.getElementById('vis-container');
            const status = document.getElementById('export-status');
            status.textContent = 'ğŸ–¼ï¸ æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...';
            status.classList.remove('hidden');

            // å¦‚æœæ˜¯ 3D æ¨¡å¼ï¼Œrenderer.domElement å°±æ˜¯æˆ‘ä»¬è¦è½¬åŒ–çš„ canvas
            const targetElement = visualizationMode === '3D' ? renderer.domElement : container;
            
            html2canvas(targetElement, { 
                scale: 2, // æé«˜åˆ†è¾¨ç‡
                backgroundColor: null, 
                useCORS: true 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `trajectory_${visualizationMode}_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                status.textContent = 'âœ… PNG å¯¼å‡ºæˆåŠŸï¼';
                setTimeout(() => status.classList.add('hidden'), 3000);
            }).catch(err => {
                status.textContent = 'âŒ PNG å¯¼å‡ºå¤±è´¥: ' + err.message;
            });
        });

        // 2. å¯¼å‡º GIF (å¼¹å‡ºè®¾ç½®)
        document.getElementById('export-gif-btn').addEventListener('click', () => {
            showExportModal('GIF');
        });
        
        // 3. å¯¼å‡º Video (å¼¹å‡ºè®¾ç½®)
        document.getElementById('export-video-btn').addEventListener('click', () => {
            showExportModal('Video');
        });
        
        /**
         * @description å¼¹å‡ºå¯¼å‡ºè®¾ç½®æ¨¡æ€æ¡†
         * @param {string} type - 'GIF' æˆ– 'Video'
         */
        function showExportModal(type) {
            if (cleanData.length === 0) {
                document.getElementById('status-bar').textContent = 'âš ï¸ è¯·å…ˆä¸Šä¼ æ•°æ®ï¼';
                return;
            }

            stopPlayback(); // æš‚åœå½“å‰åŠ¨ç”»
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('modal-backdrop').classList.add('flex');

            let content = `
                <h3 class="text-2xl font-bold mb-4">${type} å¯¼å‡ºè®¾ç½®</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å¸§ç‡ (FPS: 1-60)</label>
                        <input type="number" id="export-fps" value="30" min="1" max="60" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>`;

            if (type === 'Video') {
                content += `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">åˆ†è¾¨ç‡</label>
                        <select id="export-resolution" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            <option value="720">720p (1280x720)</option>
                            <option value="1080">1080p (1920x1080)</option>
                        </select>
                    </div>`;
            }
            
            content += `
                    <div id="export-progress-text" class="text-sm text-center text-blue-600 hidden"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="modal-close-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                    <button id="modal-start-export-btn" data-type="${type}" class="px-4 py-2 text-sm font-medium text-white bg-blue-500 rounded-md hover:bg-blue-600">å¼€å§‹å¯¼å‡º</button>
                </div>`;

            document.getElementById('modal-content').innerHTML = content;

            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            document.getElementById('modal-start-export-btn').addEventListener('click', handleExportStart);
        }

        function closeModal() {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.getElementById('modal-backdrop').classList.remove('flex');
        }

        function handleExportStart(e) {
            const type = e.target.getAttribute('data-type');
            const fps = parseInt(document.getElementById('export-fps').value);
            const resolution = document.getElementById('export-resolution')?.value;

            if (type === 'GIF') {
                exportGIF(fps);
            } else if (type === 'Video') {
                exportVideo(fps, resolution);
            }
        }
        
        /**
         * @description å¯¼å‡º GIF åŠ¨ç”» (ä½¿ç”¨ gif.js æ¨¡æ‹Ÿ)
         * @param {number} fps - å¸§ç‡
         */
        function exportGIF(fps) {
            // çœŸå®çš„ gif.js è¿è¡Œåœ¨ Worker ä¸­ï¼Œè€—æ—¶é•¿ï¼Œè¿™é‡Œä»…åšé€»è¾‘æ¼”ç¤ºã€‚
            const progressEl = document.getElementById('export-progress-text');
            progressEl.classList.remove('hidden');
            progressEl.textContent = 'ğŸš§ GIF å¯¼å‡ºå¼€å§‹... (è€—æ—¶è¾ƒé•¿)';
            
            // è®¾å®šæ€»å¸§æ•°
            const totalFramesToCapture = totalFrames; 
            let frameCounter = 0;
            
            // 1. åˆå§‹åŒ– GIF å®ä¾‹
            const gif = new GIF({
                workers: 2,
                quality: 10,
                delay: 1000 / fps // å¸§é—´éš”æ—¶é—´ (ms)
            });

            // 2. æ•è·å¸§
            function captureFrame(index) {
                if (index >= totalFramesToCapture) {
                    // æ‰€æœ‰å¸§æ•è·å®Œæ¯•ï¼Œå¼€å§‹æ¸²æŸ“
                    progressEl.textContent = 'æ¸²æŸ“ä¸­... è¯·ç¨å€™ã€‚';
                    gif.on('finished', function(blob) {
                        const url = URL.createObjectURL(blob);
                        progressEl.innerHTML = `<a href="${url}" download="trajectory_animation.gif" class="text-green-600 font-bold">âœ… GIF å¯¼å‡ºæˆåŠŸï¼ç‚¹å‡»ä¸‹è½½</a>`;
                        setTimeout(closeModal, 5000);
                        resetPlayback(cleanData); // é‡ç½®æ’­æ”¾çŠ¶æ€
                    });
                    gif.render();
                    return;
                }
                
                // è®¾ç½®åˆ°å½“å‰å¸§
                currentFrameIndex = index;
                updateVisualizations();

                const targetCanvas = visualizationMode === '3D' ? renderer.domElement : canvas2d;
                
                // ä½¿ç”¨ html2canvas/domToImage æ•è· Canvas å›¾åƒ (å¼‚æ­¥æ“ä½œ)
                html2canvas(targetCanvas, { scale: 1, useCORS: true }).then(canvas => {
                    gif.addFrame(canvas, { delay: 1000 / fps });
                    frameCounter++;
                    progressEl.textContent = `ğŸ–¼ï¸ æ•è·è¿›åº¦: ${Math.floor((frameCounter / totalFramesToCapture) * 100)}%`;
                    
                    // é€’å½’è°ƒç”¨ä¸‹ä¸€å¸§
                    requestAnimationFrame(() => captureFrame(index + 1));
                });
            }
            
            // 3. å¼€å§‹æ•è·
            captureFrame(0);
        }
        
        /**
         * @description å¯¼å‡º MP4 è§†é¢‘ (ä½¿ç”¨ RecordRTC)
         * @param {number} fps - å¸§ç‡
         * @param {string} resolution - åˆ†è¾¨ç‡ ('720' æˆ– '1080')
         */
        function exportVideo(fps, resolution) {
            const progressEl = document.getElementById('export-progress-text');
            progressEl.classList.remove('hidden');
            progressEl.textContent = 'ğŸš§ è§†é¢‘å¯¼å‡ºå¼€å§‹... (éœ€è¦æµè§ˆå™¨æƒé™)';

            const container = document.getElementById('vis-container');
            let width = container.clientWidth;
            let height = container.clientHeight;

            if (resolution === '1080') {
                width = 1920;
                height = 1080;
            } else if (resolution === '720') {
                width = 1280;
                height = 720;
            }

            // è·å–è¦å½•åˆ¶çš„ Canvas
            const targetCanvas = visualizationMode === '3D' ? renderer.domElement : canvas2d;
            
            // ä½¿ç”¨ captureStream è·å– MediaStream
            const stream = targetCanvas.captureStream(fps);
            
            const recorder = RecordRTC(stream, {
                type: 'video',
                mimeType: 'video/mp4', // å°è¯•ä½¿ç”¨ mp4
                // ä»…å½•åˆ¶è§†é¢‘
                video: true,
                canvas: { width: width, height: height },
                frameRate: fps,
                // bitsPerSecond: 8000000 // 8Mbit/s
            });

            recorder.startRecording();
            
            // æ’­æ”¾åŠ¨ç”»å¹¶å½•åˆ¶
            const totalFramesToCapture = totalFrames;
            let frameCounter = 0;
            
            // é‡æ–°å¼€å§‹æ’­æ”¾ï¼Œå¹¶ä»¥å›ºå®šçš„å¸§ç‡é©±åŠ¨
            currentFrameIndex = 0;
            const intervalTime = 1000 / fps; // ä¸¥æ ¼æŒ‰ç…§ fps æ¨è¿›
            
            const captureInterval = setInterval(() => {
                if (currentFrameIndex < totalFramesToCapture) {
                    currentFrameIndex++;
                    updateVisualizations(); // æ¨è¿›åŠ¨ç”»
                    frameCounter++;
                    progressEl.textContent = `ğŸ¥ å½•åˆ¶è¿›åº¦: ${Math.floor((frameCounter / totalFramesToCapture) * 100)}%`;
                } else {
                    clearInterval(captureInterval);
                    recorder.stopRecording(() => {
                        const blob = recorder.getBlob();
                        const url = URL.createObjectURL(blob);
                        progressEl.innerHTML = `<a href="${url}" download="trajectory_video.mp4" class="text-green-600 font-bold">âœ… è§†é¢‘å¯¼å‡ºæˆåŠŸï¼ç‚¹å‡»ä¸‹è½½</a>`;
                        setTimeout(closeModal, 5000);
                        resetPlayback(cleanData); // é‡ç½®æ’­æ”¾çŠ¶æ€
                    });
                }
            }, intervalTime);
        }
        
        // ------------------------------------
        // --- VII. äº¤äº’ä¸è®¾ç½® (ç®€åŒ–) ---
        // ------------------------------------
        
        // è®¾ç½®é¢æ¿æŠ˜å 
        document.getElementById('settings-toggle').addEventListener('click', () => {
            const panel = document.getElementById('settings-panel');
            const icon = document.querySelector('#settings-toggle span');
            panel.classList.toggle('hidden');
            icon.textContent = panel.classList.contains('hidden') ? 'â–¶' : 'â–¼';
        });

        // é¼ æ ‡åæ ‡æ˜¾ç¤º (2D æ¨¡å¼)
        document.getElementById('vis-canvas-2d').addEventListener('mousemove', (e) => {
            if (visualizationMode !== '2D' || !chart2d || cleanData.length === 0) return;
            
            const rect = canvas2d.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            // é€†å‘æ˜ å°„å±å¹•åæ ‡åˆ°æ•°æ®åæ ‡ (éœ€è¦ Chart.js å®ä¾‹)
            const xVal = chart2d.scales.x.getValueForPixel(mouseX);
            const yVal = chart2d.scales.y.getValueForPixel(mouseY);
            
            const coordsDiv = document.getElementById('mouse-coords');
            coordsDiv.textContent = `(X: ${xVal.toFixed(2)}, Y: ${yVal.toFixed(2)})`;
            coordsDiv.classList.remove('hidden');
        });

        document.getElementById('vis-canvas-2d').addEventListener('mouseleave', () => {
             document.getElementById('mouse-coords').classList.add('hidden');
        });
        
        // å®æ—¶æ›´æ–°å‚æ•° (æ‰€æœ‰æ»‘å—)
        document.querySelectorAll('#settings-panel input[type="range"]').forEach(slider => {
            slider.addEventListener('input', (e) => {
                const id = e.target.id;
                const value = e.target.value;
                document.getElementById(id.replace('-slider', '-val')).textContent = value;
                // å®æ—¶æ›´æ–°å¯è§†åŒ–
                updateVisualizations();
            });
        });
        
        // 3D è½´æ˜¾ç¤ºåˆ‡æ¢
        document.getElementById('show-axes')?.addEventListener('change', updateVisualizations);

        // å¸®åŠ©/è¯´æ˜å¼¹çª—
        document.getElementById('help-btn').addEventListener('click', () => {
             document.getElementById('modal-backdrop').classList.remove('hidden');
             document.getElementById('modal-backdrop').classList.add('flex');
             document.getElementById('modal-content').innerHTML = `
                <h3 class="text-2xl font-bold mb-4">å¸®åŠ©ä¸ä½¿ç”¨è¯´æ˜</h3>
                <p class="mb-3">æœ¬å·¥å…·ç”¨äºåŠ¨æ€ç‰©ä½“è½¨è¿¹çƒ­åŠ›å›¾å¯è§†åŒ–ï¼ŒåŸºäº CSV æ•°æ®ã€‚</p>
                <h4 class="text-lg font-semibold mb-2">CSV æ•°æ®æ ¼å¼è¦æ±‚</h4>
                <p class="text-sm bg-gray-100 p-3 rounded-md">
                    CSV æ–‡ä»¶å¿…é¡»åŒ…å«ä»¥ä¸‹**å›ºå®šåˆ—å** (å¤§å°å†™æ•æ„Ÿ)ï¼š<br>
                    <code class="font-mono text-red-600">timestamp</code> (ç§’), 
                    <code class="font-mono text-red-600">x_2d</code>, 
                    <code class="font-mono text-red-600">y_2d</code>, 
                    <code class="font-mono text-red-600">x_3d(m)</code> (ç±³), 
                    <code class="font-mono text-red-600">y_3d(m)</code> (ç±³), 
                    <code class="font-mono text-red-600">z_3d(m)</code> (ç±³)
                </p>
                <h4 class="text-lg font-semibold mt-4 mb-2">åŠŸèƒ½æ“ä½œæ­¥éª¤</h4>
                <ul class="list-disc list-inside text-sm space-y-1">
                    <li>**æ•°æ®ä¸Šä¼ :** ç‚¹å‡»æˆ–æ‹–æ‹½ CSV æ–‡ä»¶åˆ°å·¦ä¾§åŒºåŸŸï¼Œåº•éƒ¨çŠ¶æ€æ ä¼šæ˜¾ç¤ºè§£æç»“æœã€‚</li>
                    <li>**æ¨¡å¼åˆ‡æ¢:** ä½¿ç”¨å¯è§†åŒ–åŒºåŸŸä¸Šæ–¹çš„æŒ‰é’®åˆ‡æ¢ 2D æˆ– 3D è§†å›¾ã€‚</li>
                    <li>**åŠ¨æ€æ’­æ”¾:** ä½¿ç”¨å³ä¾§é¢æ¿çš„æ’­æ”¾/æš‚åœ/é‡ç½®æŒ‰é’®æ§åˆ¶åŠ¨ç”»ï¼Œå¯é€šè¿‡æ»‘å—è°ƒèŠ‚é€Ÿåº¦å’Œæ—¶é—´è½´ã€‚</li>
                    <li>**äº¤äº’:** 2D è§†å›¾æ”¯æŒé¼ æ ‡æ‹–æ‹½å¹³ç§»ã€æ»šè½®ç¼©æ”¾ï¼›3D è§†å›¾æ”¯æŒå·¦é”®æ—‹è½¬ã€å³é”®å¹³ç§»ã€æ»šè½®ç¼©æ”¾ã€‚</li>
                    <li>**å¯¼å‡º:** å¯¼å‡ºåŠŸèƒ½åœ¨å³ä¸‹è§’ï¼Œç‚¹å‡»åå¯è®¾ç½®å‚æ•°å¹¶ç”Ÿæˆ PNG/GIF/MP4 æ–‡ä»¶ã€‚</li>
                </ul>
                <div class="mt-6 flex justify-end">
                    <button id="modal-close-btn-help" class="px-4 py-2 text-sm font-medium text-white bg-blue-500 rounded-md hover:bg-blue-600">å…³é—­</button>
                </div>`;
            document.getElementById('modal-close-btn-help').addEventListener('click', closeModal);
        });
        
    </script>

</body>
</html>
Initial commit: Add trajectory visualizer index.html
