<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨æ€è½¨è¿¹å¯è§†åŒ–å·¥å…· (3D & 2D)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        /* ç¡®ä¿å¯è§†åŒ–å®¹å™¨å æ»¡å‰©ä½™ç©ºé—´ */
        #vis-container {
            flex-grow: 1;
            position: relative;
            background-color: #27272a; /* ä½¿ç”¨é»˜è®¤èƒŒæ™¯è‰² */
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        /* è¿›åº¦æ¡æ ·å¼ */
        #progress-bar {
            height: 4px;
            background-color: #f59e0b; /* æ©™è‰² */
            width: 0%;
            transition: width 0.3s;
        }
        .vis-canvas-3d, .vis-canvas-2d {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; /* é»˜è®¤éšè—ï¼Œé€šè¿‡ JS æ§åˆ¶æ˜¾ç¤º */
        }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <header class="bg-white shadow p-4 flex justify-between items-center z-10">
        <h1 class="text-xl font-bold text-gray-800">ğŸš€ è½¨è¿¹åŠ¨æ€å¯è§†åŒ–å·¥å…· (v1.0)</h1>
        <div id="status" class="text-sm font-medium text-gray-600">è¯·ä¸Šä¼  CSV æ–‡ä»¶å¼€å§‹è§£æ...</div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-80 p-4 bg-gray-50 border-r overflow-y-auto">
            <h2 class="text-lg font-semibold mb-3 text-gray-800">æ§åˆ¶é¢æ¿</h2>
            
            <div class="mb-5 p-3 border rounded-lg bg-white shadow-sm">
                <h3 class="font-medium text-gray-700 mb-2">æ•°æ®åŠ è½½</h3>
                <input type="file" id="csv-file" accept=".csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-600 hover:file:bg-yellow-100">
                <div id="progress-container" class="mt-2 rounded-full overflow-hidden bg-gray-200 hidden">
                    <div id="progress-bar"></div>
                </div>
            </div>

            <div class="mb-5 p-3 border rounded-lg bg-white shadow-sm">
                <h3 class="font-medium text-gray-700 mb-2">æ¨¡å¼é€‰æ‹©</h3>
                <select id="vis-mode" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="2d">2D çƒ­åŠ›å›¾ (x_2d, y_2d)</option>
                    <option value="3d">3D è½¨è¿¹ (x_3d, y_3d, z_3d)</option>
                </select>
            </div>

            <div id="playback-controls" class="mb-5 p-3 border rounded-lg bg-white shadow-sm" style="display: none;">
                <h3 class="font-medium text-gray-700 mb-2">åŠ¨æ€æ’­æ”¾</h3>

                <button id="play-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition duration-150 ease-in-out flex items-center mb-3">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg>
                    <span class="ml-2">æ’­æ”¾/æš‚åœ</span>
                </button>

                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-700">å¸§è¿›åº¦ (<span id="frame-val">0</span> / <span id="frame-max">0</span>)</label>
                    <input type="range" id="frame-slider" min="0" max="0" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-700">æ’­æ”¾é€Ÿåº¦ (<span id="speed-val">1.0</span>x)</label>
                    <input type="range" id="speed-slider" min="0.1" max="5.0" step="0.1" value="1.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <div class="text-sm border-t pt-3 mt-3">
                    <p>æ€»æ—¶é•¿: <span id="total-time">0</span> s</p>
                    <p>æœ€å¿«é€Ÿåº¦: <span id="max-speed">0</span> m/s</p>
                    <p>å¹³å‡é€Ÿåº¦: <span id="avg-speed">0</span> m/s</p>
                </div>
            </div>

            <div class="p-3 border rounded-lg bg-white shadow-sm">
                <h3 class="font-medium text-gray-700 mb-2">å¯è§†åŒ–é…ç½®</h3>
                
                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-700">ç‚¹/åœ†åœˆå°ºå¯¸ (<span id="size-val">5</span>)</label>
                    <input type="range" id="size-slider" min="1" max="20" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-700">ä¸é€æ˜åº¦ (<span id="opacity-val">0.5</span>)</label>
                    <input type="range" id="opacity-slider" min="0.1" max="1.0" step="0.1" value="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <p class="text-xs text-gray-500 mt-2">é¢œè‰²é…ç½®è¯·ç›´æ¥ä¿®æ”¹ JS ä»£ç ä¸­çš„ `colorConfig` å˜é‡ã€‚</p>
            </div>

        </aside>

        <main id="vis-container" class="flex-1 bg-gray-200 relative">
            <canvas id="vis-2d" class="vis-canvas-2d"></canvas>
            <canvas id="vis-3d" class="vis-canvas-3d"></canvas>
        </main>

    </div>


    <script>
        // =================================================================
        // å…¨å±€å˜é‡å®šä¹‰
        // =================================================================

        let allData = [];           // åŸå§‹è§£ææ•°æ®
        let cleanData = [];         // æ¸…ç†åçš„æœ‰æ•ˆæ•°æ®
        let chart2d = null;         // Chart.js å®ä¾‹
        let currentVisMode = '2d';  // å½“å‰æ¨¡å¼

        // 3D Three.js å˜é‡
        let scene, camera, renderer, controls;
        let pointsCloud2D, pointsCloud3D, currentSphere;
        let line3D;
        let animationFrameId;

        // æ’­æ”¾æ§åˆ¶å˜é‡
        let currentFrameIndex = 0;
        let playInterval = null;
        let playbackSpeed = 1.0;
        const baseInterval = 10; // åŸºç¡€é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

        // --- é¢œè‰²é…ç½®å˜é‡ (å‚è€ƒç”¨æˆ·å›¾ç‰‡ï¼Œä½¿ç”¨æ·±è‰²èƒŒæ™¯å’Œäº®è‰²ç‚¹) ---
        let colorConfig = {
            historyLine: 'rgba(59, 130, 246, 0.4)', // å†å²è½¨è¿¹çº¿ (æ·¡è“)
            currentPoint: 'rgba(255, 255, 0, 1.0)', // å½“å‰é«˜äº®ç‚¹ (é»„è‰²)
            heatmapColor: 'rgba(255, 0, 0, 1.0)',   // çƒ­åŠ›ç‚¹åŸºç¡€è‰² (çº¢è‰²)
            backgroundColor: '#27272a'              // å¯è§†åŒ–åŒºåŸŸèƒŒæ™¯è‰² (æ·±ç°)
        };

        // =================================================================
        // æ ¸å¿ƒå‡½æ•°ï¼šæ•°æ®å¤„ç†
        // =================================================================

        /**
         * æ¸…ç†å¹¶å¤„ç†æ•°æ®ï¼Œç­›é€‰å‡ºæœ‰æ•ˆçš„ 3D/2D åæ ‡ã€‚
         * ç¡®ä¿åˆ—åå’Œæ•°æ®ç±»å‹æ­£ç¡®ã€‚
         */
        function processAndCleanData(data) {
            const requiredFields = ['timestamp', 'x_2d', 'y_2d', 'x_3d(m)', 'y_3d(m)', 'z_3d(m)'];
            
            if (data.length === 0 || !requiredFields.every(field => data[0].hasOwnProperty(field))) {
                document.getElementById('status').textContent = 'âŒ æ•°æ®åˆ—åé”™è¯¯æˆ–æ•°æ®ä¸ºç©ºã€‚';
                return [];
            }

            return data.filter(d => {
                // ç¡®ä¿æ‰€æœ‰å…³é”®å­—æ®µéƒ½æ˜¯æ•°å­—ä¸”ä¸ä¸ºç©º
                return requiredFields.every(field => typeof d[field] === 'number' && !isNaN(d[field]));
            });
        }

        /**
         * è®¡ç®—è¿åŠ¨æŒ‡æ ‡ï¼ˆæ€»æ—¶é•¿ã€é€Ÿåº¦ç­‰ï¼‰
         */
        function calculateMotionMetrics(data) {
            if (data.length < 2) {
                document.getElementById('total-time').textContent = '0';
                document.getElementById('max-speed').textContent = '0';
                document.getElementById('avg-speed').textContent = '0';
                return;
            }

            // å‡è®¾æ—¶é—´æˆ³å•ä½ä¸ºç§’ (s)
            const startTime = data[0].timestamp;
            const endTime = data[data.length - 1].timestamp;
            const totalTime = endTime - startTime;
            
            let totalDistance = 0;
            let maxSpeed = 0;
            
            for (let i = 1; i < data.length; i++) {
                const prev = data[i - 1];
                const curr = data[i];
                
                // 3D è·ç¦» (ç±³)
                const distance = Math.sqrt(
                    Math.pow(curr['x_3d(m)'] - prev['x_3d(m)'], 2) +
                    Math.pow(curr['y_3d(m)'] - prev['y_3d(m)'], 2) +
                    Math.pow(curr['z_3d(m)'] - prev['z_3d(m)'], 2)
                );
                
                // æ—¶é—´å·® (ç§’)
                const timeDiff = curr.timestamp - prev.timestamp;

                if (timeDiff > 0) {
                    const speed = distance / timeDiff;
                    totalDistance += distance;
                    if (speed > maxSpeed) {
                        maxSpeed = speed;
                    }
                }
            }
            
            const avgSpeed = totalDistance / totalTime || 0;

            document.getElementById('total-time').textContent = totalTime.toFixed(2);
            document.getElementById('max-speed').textContent = maxSpeed.toFixed(2);
            document.getElementById('avg-speed').textContent = avgSpeed.toFixed(2);
        }

        // =================================================================
        // æ ¸å¿ƒå‡½æ•°ï¼šå¯è§†åŒ–åˆå§‹åŒ–ä¸æ›´æ–°
        // =================================================================

        /**
         * åˆå§‹åŒ– 2D Chart.js å›¾è¡¨
         */
        function init2DChart() {
            const ctx = document.getElementById('vis-2d').getContext('2d');
            if (chart2d) {
                chart2d.destroy(); // é”€æ¯æ—§å®ä¾‹
            }
            
            // ç¡®ä¿ä½¿ç”¨æ·±è‰²èƒŒæ™¯
            const bgColor = colorConfig.backgroundColor;
            const textColor = '#e4e4e7'; // æµ…è‰²æ–‡å­—

            chart2d = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'å½“å‰ç‚¹',
                        data: [],
                        // å¼•ç”¨ currentPoint é¢œè‰²
                        backgroundColor: colorConfig.currentPoint, 
                        pointRadius: 5,
                        borderColor: 'rgba(0, 0, 0, 0)',
                        borderWidth: 0,
                    },
                    {
                        label: 'å†å²è½¨è¿¹',
                        data: [],
                        // å¼•ç”¨ historyLine é¢œè‰²
                        backgroundColor: colorConfig.historyLine, 
                        borderColor: colorConfig.historyLine,
                        borderWidth: 1,
                        showLine: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: { labels: { color: textColor } },
                        title: { display: true, text: '2D è½¨è¿¹ (x_2d, y_2d)', color: textColor }
                    },
                    scales: {
                        x: { type: 'linear', position: 'bottom', title: { display: true, text: 'X (åƒç´ )', color: textColor }, ticks: { color: textColor }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { type: 'linear', title: { display: true, text: 'Y (åƒç´ )', color: textColor }, ticks: { color: textColor }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    },
                    // è®¾ç½®èƒŒæ™¯è‰²
                    layout: {
                        padding: 10
                    },
                    backgroundColor: bgColor
                }
            });
            // ç¡®ä¿ Canvas å…ƒç´ çš„èƒŒæ™¯è‰²ä¹Ÿè¢«è®¾ç½®
            document.getElementById('vis-2d').style.backgroundColor = bgColor;
        }

        /**
         * åˆå§‹åŒ– 3D Three.js åœºæ™¯
         */
        function init3DScene() {
            const container = document.getElementById('vis-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            const canvas3d = document.getElementById('vis-3d');

            // 1. åœºæ™¯ (Scene)
            scene = new THREE.Scene();
            scene.background = new THREE.Color(colorConfig.backgroundColor.replace('#', '0x')); // è®¾ç½®èƒŒæ™¯è‰²

            // 2. ç›¸æœº (Camera) - ä½¿ç”¨é€è§†ç›¸æœº
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 100000); // å¢å¤§ far plane
            camera.position.set(200, 200, 200); // åˆå§‹ç›¸æœºä½ç½®ï¼Œè°ƒæ•´åˆ°åˆé€‚èŒƒå›´

            // 3. æ¸²æŸ“å™¨ (Renderer)
            renderer = new THREE.WebGLRenderer({ canvas: canvas3d, antialias: true });
            renderer.setSize(width, height);
            
            // 4. äº¤äº’æ§åˆ¶ (Controls)
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; 
            controls.dampingFactor = 0.05;

            // 5. å…‰æº
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(100, 100, 100);
            scene.add(directionalLight);

            // 6. åæ ‡è½´ (Axes Helper)
            // è‡ªåŠ¨æ ¹æ®æ•°æ®èŒƒå›´è°ƒæ•´åæ ‡è½´å¤§å°ä¼šæ›´å¥½ï¼Œè¿™é‡Œå…ˆç»™ä¸€ä¸ªå¤§å€¼
            const axesHelper = new THREE.AxesHelper(5000); 
            axesHelper.name = 'Axes';
            scene.add(axesHelper);

            // 7. æ¸²æŸ“å¾ªç¯ (Animate Loop)
            function animate() {
                animationFrameId = requestAnimationFrame(animate);
                controls.update(); // å¿…é¡»è°ƒç”¨
                renderer.render(scene, camera);
            }
            animate();
        }


        /**
         * æ¸²æŸ“ 3D å¯è§†åŒ–
         */
        function render3DVisualization(data) {
            // 1. æ¸…ç†æ—§çš„è½¨è¿¹å’Œç‚¹
            const oldPoints = scene.getObjectByName('TrajectoryPoints');
            const oldLine = scene.getObjectByName('TrajectoryLine');
            const oldSphere = scene.getObjectByName('CurrentPoint');
            
            if (oldPoints) scene.remove(oldPoints);
            if (oldLine) scene.remove(oldLine);
            if (oldSphere) scene.remove(oldSphere);
            
            // 2. ç»˜åˆ¶ 3D è½¨è¿¹çº¿
            const points = data.map(d => new THREE.Vector3(d['x_3d(m)'], d['y_3d(m)'], d['z_3d(m)']));
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.LineBasicMaterial({ 
                color: new THREE.Color(colorConfig.historyLine),
                transparent: true,
                opacity: 0.8
            });
            line3D = new THREE.Line(geometry, material);
            line3D.name = 'TrajectoryLine';
            scene.add(line3D);

            // 3. ç»˜åˆ¶ 3D çƒ­åŠ›ç‚¹ (Point Cloud)
            const pointsMaterial = new THREE.PointsMaterial({
                color: new THREE.Color(colorConfig.heatmapColor), 
                size: parseFloat(document.getElementById('size-slider').value) * 0.5, 
                transparent: true,
                opacity: parseFloat(document.getElementById('opacity-slider').value),
                sizeAttenuation: true // ç¡®ä¿ç‚¹çš„å¤§å°ä¼šéšè·ç¦»å˜åŒ–
            });
            pointsCloud3D = new THREE.Points(geometry, pointsMaterial);
            pointsCloud3D.name = 'TrajectoryPoints';
            scene.add(pointsCloud3D);

            // 4. æ›´æ–°å½“å‰é«˜äº®ç‚¹ (Current Point Sphere)
            update3DPoint(data[currentFrameIndex]);
        }

        /**
         * æ›´æ–° 2D è½¨è¿¹å’Œå½“å‰ç‚¹
         */
        function update2DChart() {
            if (!chart2d || cleanData.length === 0) return;

            const maxFrames = parseInt(document.getElementById('frame-slider').max);
            
            // 1. å†å²è½¨è¿¹çº¿ (ä»å¤´åˆ°å½“å‰å¸§)
            const historyData = cleanData.slice(0, currentFrameIndex + 1).map(d => ({ x: d.x_2d, y: d.y_2d }));
            chart2d.data.datasets[1].data = historyData;

            // 2. å½“å‰ç‚¹ (åªæ˜¾ç¤ºä¸€ä¸ªç‚¹)
            const currentPoint = cleanData[currentFrameIndex];
            chart2d.data.datasets[0].data = currentPoint ? [{ x: currentPoint.x_2d, y: currentPoint.y_2d }] : [];
            chart2d.data.datasets[0].pointRadius = parseInt(document.getElementById('size-slider').value);
            chart2d.data.datasets[0].backgroundColor = colorConfig.currentPoint; 
            
            chart2d.update('none'); 
        }

        /**
         * æ›´æ–° 3D åœºæ™¯ä¸­çš„å½“å‰ç‚¹ä½ç½®
         */
        function update3DPoint(pointData) {
            const oldSphere = scene.getObjectByName('CurrentPoint');
            if (oldSphere) scene.remove(oldSphere);
            
            if (!pointData) return;

            // ç»˜åˆ¶å½“å‰é«˜äº®ç‚¹ (Sphere)
            const radius = parseFloat(document.getElementById('size-slider').value) * 1.5; // åŠå¾„æ¯”ç‚¹äº‘å¤§
            const sphereGeometry = new THREE.SphereGeometry(radius, 16, 16); 
            const sphereMaterial = new THREE.MeshBasicMaterial({ color: new THREE.Color(colorConfig.currentPoint) });
            
            currentSphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
            currentSphere.position.set(pointData['x_3d(m)'], pointData['y_3d(m)'], pointData['z_3d(m)']);
            currentSphere.name = 'CurrentPoint';
            scene.add(currentSphere);

            // ä¼˜åŒ–ï¼šå°†ç›¸æœºå¯¹å‡†å½“å‰ç‚¹
            // controls.target.copy(currentSphere.position);
            // controls.update();

            renderer.render(scene, camera);
        }
        
        // =================================================================
        // UI å’Œæ§åˆ¶å‡½æ•°
        // =================================================================

        /**
         * åˆ‡æ¢ 2D/3D å¯è§†åŒ–æ¨¡å¼
         */
        function switchVisualizationMode(mode) {
            currentVisMode = mode;
            const vis2d = document.getElementById('vis-2d');
            const vis3d = document.getElementById('vis-3d');

            if (mode === '2d') {
                vis2d.style.display = 'block';
                vis3d.style.display = 'none';
                if (!chart2d) init2DChart();
                updateVisualizations();
            } else {
                vis2d.style.display = 'none';
                vis3d.style.display = 'block';
                if (!scene) init3DScene();
                render3DVisualization(cleanData);
            }
        }
        
        /**
         * æ›´æ–°æ‰€æœ‰å¯è§†åŒ–å†…å®¹ (2D å’Œ 3D)
         */
        function updateVisualizations() {
            if (cleanData.length === 0) return;
            
            if (currentVisMode === '2d') {
                update2DChart();
            } else {
                // 3D æ¨¡å¼ä¸‹ï¼Œä¸»è¦é€šè¿‡ update3DPoint æ›´æ–°å½“å‰ç‚¹
                if (scene) {
                    // å¦‚æœæ˜¯åˆå§‹æ¸²æŸ“ï¼Œéœ€è¦å…ˆæ¸²æŸ“æ‰€æœ‰è½¨è¿¹ç‚¹å’Œçº¿
                    if (!scene.getObjectByName('TrajectoryLine')) {
                         render3DVisualization(cleanData);
                    }
                    update3DPoint(cleanData[currentFrameIndex]);
                } else {
                    init3DScene();
                    render3DVisualization(cleanData);
                }
            }
        }

        /**
         * é‡ç½®æ’­æ”¾çŠ¶æ€
         */
        function resetPlayback(data) {
            stopPlayback();
            currentFrameIndex = 0;
            const maxFrame = data.length > 0 ? data.length - 1 : 0;
            
            document.getElementById('frame-slider').max = maxFrame;
            document.getElementById('frame-slider').value = 0;
            document.getElementById('frame-max').textContent = maxFrame;
            document.getElementById('frame-val').textContent = 0;
            document.getElementById('playback-controls').style.display = 'block';

            updateVisualizations();
        }

        /**
         * å¼€å§‹åŠ¨æ€æ’­æ”¾
         */
        function startPlayback() {
            if (playInterval) return;

            const intervalTime = baseInterval / playbackSpeed;
            const totalFrames = cleanData.length - 1;
            
            document.getElementById('play-btn').innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM7.25 7a.75.75 0 00-1.5 0v6a.75.75 0 001.5 0V7zM11.25 7a.75.75 0 00-1.5 0v6a.75.75 0 001.5 0V7zM15.25 7a.75.75 0 00-1.5 0v6a.75.75 0 001.5 0V7z"></path></svg><span class="ml-2">æš‚åœ</span>';

            playInterval = setInterval(() => {
                if (currentFrameIndex >= totalFrames) {
                    stopPlayback();
                    // æ’­æ”¾ç»“æŸåï¼ŒæŒ‰é’®åˆ‡å›æ’­æ”¾çŠ¶æ€
                    document.getElementById('play-btn').innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg><span class="ml-2">æ’­æ”¾</span>';
                    return;
                }
                
                currentFrameIndex++;
                document.getElementById('frame-slider').value = currentFrameIndex;
                document.getElementById('frame-val').textContent = currentFrameIndex;
                updateVisualizations();

            }, intervalTime);
        }

        /**
         * åœæ­¢åŠ¨æ€æ’­æ”¾
         */
        function stopPlayback() {
            clearInterval(playInterval);
            playInterval = null;
            document.getElementById('play-btn').innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg><span class="ml-2">æ’­æ”¾</span>';
        }

        // =================================================================
        // äº‹ä»¶ç›‘å¬å™¨
        // =================================================================

        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            document.getElementById('csv-file').addEventListener('change', handleFileUpload);
            
            // 2. æ¨¡å¼åˆ‡æ¢äº‹ä»¶
            document.getElementById('vis-mode').addEventListener('change', (e) => {
                switchVisualizationMode(e.target.value);
            });
            
            // 3. æ’­æ”¾/æš‚åœæŒ‰é’®
            document.getElementById('play-btn').addEventListener('click', () => {
                if (playInterval) {
                    stopPlayback();
                } else {
                    // å¦‚æœå·²åˆ°ç»ˆç‚¹ï¼Œä»å¤´å¼€å§‹æ’­æ”¾
                    if (currentFrameIndex >= cleanData.length - 1) {
                        currentFrameIndex = 0;
                    }
                    startPlayback();
                }
            });

            // 4. è¿›åº¦æ¡æ»‘å—
            document.getElementById('frame-slider').addEventListener('input', (e) => {
                stopPlayback();
                currentFrameIndex = parseInt(e.target.value);
                document.getElementById('frame-val').textContent = currentFrameIndex;
                updateVisualizations();
            });

            // 5. é€Ÿåº¦è°ƒæ•´æ»‘å— (å…³é”®ä¿®å¤: é‡æ–°å¯åŠ¨å®šæ—¶å™¨)
            document.getElementById('speed-slider').addEventListener('input', (e) => {
                playbackSpeed = parseFloat(e.target.value);
                document.getElementById('speed-val').textContent = playbackSpeed.toFixed(1);
                if (playInterval) {
                    // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°å¯åŠ¨å®šæ—¶å™¨ä»¥åº”ç”¨æ–°é€Ÿåº¦
                    clearInterval(playInterval);
                    startPlayback(); 
                }
            });

            // 6. å°ºå¯¸å’Œä¸é€æ˜åº¦æ»‘å—
            document.getElementById('size-slider').addEventListener('input', (e) => {
                document.getElementById('size-val').textContent = e.target.value;
                // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ç‚¹å¤§å°
                updateVisualizations();
            });

            document.getElementById('opacity-slider').addEventListener('input', (e) => {
                document.getElementById('opacity-val').textContent = e.target.value;
                // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ä¸é€æ˜åº¦
                updateVisualizations();
            });

            // 7. çª—å£å°ºå¯¸è°ƒæ•´ (å“åº”å¼å¸ƒå±€)
            window.addEventListener('resize', onWindowResize);
            
            // åˆå§‹åŒ–é»˜è®¤æ¨¡å¼
            switchVisualizationMode('2d');
        });

        /**
         * çª—å£å°ºå¯¸è°ƒæ•´å‡½æ•° (ç”¨äº 2D å’Œ 3D)
         */
        function onWindowResize() {
            const container = document.getElementById('vis-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // 2D Resize
            if (chart2d) {
                chart2d.resize();
            }

            // 3D Resize
            if (camera && renderer) {
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }
        }

        /**
         * å¤„ç†æ–‡ä»¶ä¸Šä¼  (æ ¸å¿ƒè§£æé€»è¾‘)
         */
        function handleFileUpload(event) {
            const file = event.target.files[0];
            const status = document.getElementById('status');
            const progressDiv = document.getElementById('progress-container');

            if (!file) return;

            status.textContent = 'â–¶ï¸ æ­£åœ¨è§£æ CSV æ–‡ä»¶...';
            progressDiv.classList.remove('hidden');

            // 1. é‡ç½®çŠ¶æ€
            stopPlayback();
            allData = [];
            cleanData = [];
            
            // 2. ä½¿ç”¨ Papa Parse è§£æ CSV
            Papa.parse(file, {
                header: true,
                skipEmptyLines: 'greedy',
                dynamicTyping: true, // å°è¯•å°†æ•°å­—è§£æä¸ºæ•°å­—ç±»å‹
                worker: true, // å…³é”®ï¼šåœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œï¼Œé˜²æ­¢ UI å¡é¡¿
                
                complete: (results, file) => {
                    progressDiv.classList.add('hidden');
                    
                    // 3. æ£€æŸ¥æ•°æ®å’Œåˆ—å
                    if (results.data.length === 0) {
                        status.textContent = 'âŒ CSV è§£æå¤±è´¥ï¼šæ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯ã€‚';
                        return;
                    }
                    
                    allData = results.data;
                    cleanData = processAndCleanData(allData);

                    if (cleanData.length === 0) {
                        status.textContent = 'âŒ CSV è§£æå¤±è´¥ï¼šæœ‰æ•ˆæ•°æ®ç‚¹ä¸è¶³ï¼Œè¯·æ£€æŸ¥åˆ—åå’Œæ•°å€¼ã€‚';
                        return;
                    }

                    // 4. æ›´æ–° UI å’Œå¯è§†åŒ–
                    calculateMotionMetrics(cleanData);
                    resetPlayback(cleanData); // é‡ç½®å¹¶è§¦å‘åˆæ¬¡å¯è§†åŒ–
                    
                    status.textContent = `âœ… æ•°æ®åŠ è½½æˆåŠŸï¼å…± ${cleanData.length} ä¸ªæœ‰æ•ˆæ•°æ®ç‚¹ã€‚`;
                },
                error: (error, file) => {
                    progressDiv.classList.add('hidden');
                    status.textContent = `âŒ CSV è§£æé”™è¯¯: ${error.message}`;
                }
            });
        }
    </script>
</body>
</html>
