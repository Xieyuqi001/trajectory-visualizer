<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨æ€è½¨è¿¹å¯è§†åŒ–å·¥å…· (3D & 2D)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>

    <style>
        /* ç¡®ä¿å¯è§†åŒ–å®¹å™¨å æ»¡å‰©ä½™ç©ºé—´ */
        #vis-container {
            flex-grow: 1;
            position: relative;
            background-color: #27272a;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        /* è¿›åº¦æ¡æ ·å¼ */
        #progress-bar {
            height: 4px;
            background-color: #f59e0b; /* æ©™è‰² */
            width: 0%;
            transition: width 0.3s;
        }
        .vis-canvas-3d, .vis-canvas-2d {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; /* é»˜è®¤éšè—ï¼Œé€šè¿‡ JS æ§åˆ¶æ˜¾ç¤º */
        }
        .hidden { display: none; }
        .color-input {
            width: 40px;
            height: 25px;
            padding: 0;
            border: 1px solid #d1d5db;
            cursor: pointer;
            border-radius: 4px;
            /* éšè—é»˜è®¤é¢œè‰²é€‰æ‹©å™¨çš„è¾¹æ¡† */
            appearance: none;
            -moz-appearance: none;
            -webkit-appearance: none;
        }
        .color-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-input::-webkit-color-swatch {
            border: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <header class="bg-white shadow p-4 flex justify-between items-center z-10">
        <h1 class="text-xl font-bold text-gray-800">ğŸš€ è½¨è¿¹åŠ¨æ€å¯è§†åŒ–å·¥å…· (v3.0)</h1>
        <div id="status" class="text-sm font-medium text-gray-600">è¯·ä¸Šä¼  CSV æ–‡ä»¶å¼€å§‹è§£æ...</div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-80 p-4 bg-gray-50 border-r overflow-y-auto">
            <h2 class="text-lg font-semibold mb-3 text-gray-800">æ§åˆ¶é¢æ¿</h2>
            
            <div class="mb-5 p-3 border rounded-lg bg-white shadow-sm">
                <h3 class="font-medium text-gray-700 mb-2">æ•°æ®åŠ è½½</h3>
                <input type="file" id="csv-file" accept=".csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-600 hover:file:bg-yellow-100">
                <div id="progress-container" class="mt-2 rounded-full overflow-hidden bg-gray-200 hidden">
                    <div id="progress-bar"></div>
                </div>
            </div>

            <div class="mb-5 p-3 border rounded-lg bg-white shadow-sm">
                <h3 class="font-medium text-gray-700 mb-2">æ¨¡å¼é€‰æ‹©</h3>
                <select id="vis-mode" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="2d">2D çƒ­åŠ›å›¾ (x_2d, y_2d)</option>
                    <option value="3d">3D è½¨è¿¹ (x_3d, y_3d, z_3d)</option>
                </select>
            </div>

            <div id="playback-controls" class="mb-5 p-3 border rounded-lg bg-white shadow-sm" style="display: none;">
                <h3 class="font-medium text-gray-700 mb-2">åŠ¨æ€æ’­æ”¾</h3>

                <button id="play-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition duration-150 ease-in-out flex items-center mb-3">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg>
                    <span class="ml-2">æ’­æ”¾/æš‚åœ</span>
                </button>

                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-700">å¸§è¿›åº¦ (<span id="frame-val">0</span> / <span id="frame-max">0</span>)</label>
                    <input type="range" id="frame-slider" min="0" max="0" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-700">æ’­æ”¾é€Ÿåº¦ (<span id="speed-val">1.0</span>x)</label>
                    <input type="range" id="speed-slider" min="0.1" max="5.0" step="0.1" value="1.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <div class="text-sm border-t pt-3 mt-3">
                    <p>æ€»æ—¶é•¿: <span id="total-time">0</span> s</p>
                    <p>æœ€å¿«é€Ÿåº¦: <span id="max-speed">0</span> m/s</p>
                    <p>å¹³å‡é€Ÿåº¦: <span id="avg-speed">0</span> m/s</p>
                </div>
            </div>

            <div class="p-3 mb-5 border rounded-lg bg-white shadow-sm">
                <h3 class="font-medium text-gray-700 mb-2">å¤–è§‚é…ç½®</h3>
                
                <div class="space-y-2 mb-3">
                    <div class="flex items-center justify-between">
                        <label class="text-xs font-medium text-gray-700">èƒŒæ™¯é¢œè‰²</label>
                        <input type="color" id="color-background" class="color-input" value="#27272a">
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-xs font-medium text-gray-700">è½¨è¿¹çº¿/å†å²ç‚¹é¢œè‰²</label>
                        <input type="color" id="color-history" class="color-input" value="#3b82f6">
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-xs font-medium text-gray-700">å½“å‰é«˜äº®ç‚¹é¢œè‰²</label>
                        <input type="color" id="color-current" class="color-input" value="#ffff00">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-700">ç‚¹/åœ†åœˆå°ºå¯¸ (<span id="size-val">5</span>)</label>
                    <input type="range" id="size-slider" min="1" max="20" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-700">è½¨è¿¹ä¸é€æ˜åº¦ (<span id="opacity-val">0.5</span>)</label>
                    <input type="range" id="opacity-slider" min="0.1" max="1.0" step="0.1" value="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>

            <div class="p-3 border rounded-lg bg-white shadow-sm">
                <h3 class="font-medium text-gray-700 mb-2">å¯¼å‡º</h3>
                <div class="flex space-x-2">
                    <button id="export-image-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-2 rounded text-sm disabled:bg-gray-400" disabled>å¯¼å‡ºå›¾ç‰‡ (PNG)</button>
                    <button id="export-gif-btn" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-2 rounded text-sm disabled:bg-gray-400" disabled>å¯¼å‡ºåŠ¨ç”» (GIF)</button>
                </div>
            </div>

        </aside>

        <main id="vis-container" class="flex-1 bg-gray-200 relative">
            <canvas id="vis-2d" class="vis-canvas-2d"></canvas>
            <canvas id="vis-3d" class="vis-canvas-3d"></canvas>
            <div id="gif-progress" class="hidden absolute top-0 left-0 w-full h-full bg-black bg-opacity-70 text-white flex flex-col items-center justify-center">
                <p class="mb-4 text-lg font-semibold">æ­£åœ¨ç”Ÿæˆ GIF åŠ¨ç”»...</p>
                <div class="w-1/2 bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                    <div id="gif-progress-bar" class="bg-purple-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p id="gif-progress-text" class="mt-2 text-sm">0%</p>
            </div>
        </main>

    </div>


    <script>
        // =================================================================
        // å…¨å±€å˜é‡å®šä¹‰
        // =================================================================

        let allData = [];           // åŸå§‹è§£ææ•°æ®
        let dataRanges = null; // ç”¨äºå­˜å‚¨åŠ¨æ€è®¡ç®—çš„åæ ‡è½´èŒƒå›´
        let cleanData = [];         // æ¸…ç†åçš„æœ‰æ•ˆæ•°æ®
        let chart2d = null;         // Chart.js å®ä¾‹
        let currentVisMode = '2d';  // å½“å‰æ¨¡å¼

        // 3D Three.js å˜é‡
        let scene, camera, renderer, controls;
        let pointsCloud3D, currentSphere;
        let line3D;
        let animationFrameId;

        // æ’­æ”¾æ§åˆ¶å˜é‡
        let currentFrameIndex = 0;
        let playInterval = null;
        let playbackSpeed = 1.0;
        const baseInterval = 10; // åŸºç¡€é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

        // --- é¢œè‰²é…ç½®å˜é‡ (é€šè¿‡ UI åŠ¨æ€æ›´æ–°) ---
        let colorConfig = {
            historyLine: document.getElementById('color-history') ? document.getElementById('color-history').value : '#3b82f6',
            currentPoint: document.getElementById('color-current') ? document.getElementById('color-current').value : '#ffff00',
            backgroundColor: document.getElementById('color-background') ? document.getElementById('color-background').value : '#27272a'
        };
        
        // =================================================================
        // æ ¸å¿ƒå‡½æ•°ï¼šæ•°æ®å¤„ç†
        // =================================================================

        /**
         * æ¸…ç†å¹¶å¤„ç†æ•°æ®ï¼Œç­›é€‰å‡ºæœ‰æ•ˆçš„ 3D/2D åæ ‡ã€‚
         */
        function processAndCleanData(data) {
            const requiredFields = ['timestamp', 'x_2d', 'y_2d', 'x_3d(m)', 'y_3d(m)', 'z_3d(m)'];
            
            if (data.length === 0 || !requiredFields.every(field => data[0].hasOwnProperty(field))) {
                document.getElementById('status').textContent = 'âŒ æ•°æ®åˆ—åé”™è¯¯æˆ–æ•°æ®ä¸ºç©ºã€‚';
                return [];
            }

            return data.filter(d => {
                // ç¡®ä¿æ‰€æœ‰å…³é”®å­—æ®µéƒ½æ˜¯æ•°å­—ä¸”ä¸ä¸ºç©º
                return requiredFields.every(field => typeof d[field] === 'number' && !isNaN(d[field]));
            });
        }

        /**
         * è®¡ç®—è¿åŠ¨æŒ‡æ ‡ï¼ˆæ€»æ—¶é•¿ã€é€Ÿåº¦ç­‰ï¼‰
         */
        /**
 * è®¡ç®—æ‰€æœ‰åæ ‡è½´çš„æœ€å°å’Œæœ€å¤§èŒƒå›´ (Min/Max)
 * @param {Array} data - æ¸…ç†åçš„æ•°æ®
 * @returns {Object} åŒ…å« '2d' å’Œ '3d' èŒƒå›´çš„å¯¹è±¡
 */
        function calculateDataRanges(data) {
            if (data.length === 0) {
                return {
                    '2d': { minX: 0, maxX: 1000, minY: 0, maxY: 1000 },
                    '3d': { minX: 0, maxX: 5000, minY: 0, maxY: 5000, minZ: 0, maxZ: 5000 }
                };
            }
        
            const fields2D = ['x_2d', 'y_2d'];
            const fields3D = ['x_3d(m)', 'y_3d(m)', 'z_3d(m)'];
        
            // åˆå§‹å€¼è®¾ä¸ºç¬¬ä¸€ä¸ªæ•°æ®ç‚¹çš„å€¼
            const ranges2D = {
                minX: data[0].x_2d, maxX: data[0].x_2d,
                minY: data[0].y_2d, maxY: data[0].y_2d
            };
            const ranges3D = {
                minX: data[0]['x_3d(m)'], maxX: data[0]['x_3d(m)'],
                minY: data[0]['y_3d(m)'], maxY: data[0]['y_3d(m)'],
                minZ: data[0]['z_3d(m)'], maxZ: data[0]['z_3d(m)']
            };
        
            data.forEach(d => {
                // 2D èŒƒå›´è®¡ç®—
                ranges2D.minX = Math.min(ranges2D.minX, d.x_2d);
                ranges2D.maxX = Math.max(ranges2D.maxX, d.x_2d);
                ranges2D.minY = Math.min(ranges2D.minY, d.y_2d);
                ranges2D.maxY = Math.max(ranges2D.maxY, d.y_2d);
                
                // 3D èŒƒå›´è®¡ç®—
                ranges3D.minX = Math.min(ranges3D.minX, d['x_3d(m)']);
                ranges3D.maxX = Math.max(ranges3D.maxX, d['x_3d(m)']);
                ranges3D.minY = Math.min(ranges3D.minY, d['y_3d(m)']);
                ranges3D.maxY = Math.max(ranges3D.maxY, d['y_3d(m)']);
                ranges3D.minZ = Math.min(ranges3D.minZ, d['z_3d(m)']);
                ranges3D.maxZ = Math.max(ranges3D.maxZ, d['z_3d(m)']);
            });
            
            return { '2d': ranges2D, '3d': ranges3D };
        }
        

        
        function calculateMotionMetrics(data) {
            // ... (ä¸ä¸Šä¸€ç‰ˆæœ¬ä¿æŒä¸€è‡´) ...
             if (data.length < 2) {
                document.getElementById('total-time').textContent = '0';
                document.getElementById('max-speed').textContent = '0';
                document.getElementById('avg-speed').textContent = '0';
                return;
            }

            const startTime = data[0].timestamp;
            const endTime = data[data.length - 1].timestamp;
            const totalTime = endTime - startTime;
            
            let totalDistance = 0;
            let maxSpeed = 0;
            
            for (let i = 1; i < data.length; i++) {
                const prev = data[i - 1];
                const curr = data[i];
                
                const distance = Math.sqrt(
                    Math.pow(curr['x_3d(m)'] - prev['x_3d(m)'], 2) +
                    Math.pow(curr['y_3d(m)'] - prev['y_3d(m)'], 2) +
                    Math.pow(curr['z_3d(m)'] - prev['z_3d(m)'], 2)
                );
                
                const timeDiff = curr.timestamp - prev.timestamp;

                if (timeDiff > 0) {
                    const speed = distance / timeDiff;
                    totalDistance += distance;
                    if (speed > maxSpeed) {
                        maxSpeed = speed;
                    }
                }
            }
            
            const avgSpeed = totalDistance / totalTime || 0;

            document.getElementById('total-time').textContent = totalTime.toFixed(2);
            document.getElementById('max-speed').textContent = maxSpeed.toFixed(2);
            document.getElementById('avg-speed').textContent = avgSpeed.toFixed(2);
        }

        // =================================================================
        // æ ¸å¿ƒå‡½æ•°ï¼šå¯è§†åŒ–åˆå§‹åŒ–ä¸æ›´æ–°
        // =================================================================

        /**
         * åˆå§‹åŒ– 2D Chart.js å›¾è¡¨
         */
        function init2DChart() {
            const ctx = document.getElementById('vis-2d').getContext('2d');
            if (chart2d) {
                chart2d.destroy();
            }
            
            const bgColor = colorConfig.backgroundColor;
            const textColor = '#e4e4e7';
            // è®¡ç®—è¾¹è·ï¼ˆ10%ï¼‰
            const rangeX2D = dataRanges['2d'].maxX - dataRanges['2d'].minX;
            const rangeY2D = dataRanges['2d'].maxY - dataRanges['2d'].minY;
            const paddingX = rangeX2D * 0.1;
            const paddingY = rangeY2D * 0.1;

            chart2d = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'å½“å‰ç‚¹',
                        data: [],
                        backgroundColor: colorConfig.currentPoint, 
                        pointRadius: 5,
                        borderColor: 'rgba(0, 0, 0, 0)',
                        borderWidth: 0,
                    },
                    {
                        label: 'å†å²è½¨è¿¹',
                        data: [],
                        backgroundColor: colorConfig.historyLine, 
                        borderColor: colorConfig.historyLine,
                        borderWidth: 1,
                        showLine: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: { labels: { color: textColor } },
                        title: { display: true, text: '2D è½¨è¿¹ (x_2d, y_2d)', color: textColor }
                    },
                    scales: {
                        x: { 
                            type: 'linear', 
                            position: 'bottom', 
                            title: { display: true, text: 'X (åƒç´ )', color: textColor }, 
                            ticks: { color: textColor }, 
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            // --- åº”ç”¨åŠ¨æ€èŒƒå›´ ---
                            min: dataRanges['2d'].minX - paddingX, 
                            max: dataRanges['2d'].maxX + paddingX 
                            // ----------------------
                        },
                        y: { 
                            type: 'linear', 
                            title: { display: true, text: 'Y (åƒç´ )', color: textColor }, 
                            ticks: { color: textColor }, 
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            // --- åº”ç”¨åŠ¨æ€èŒƒå›´ ---
                            min: dataRanges['2d'].minY - paddingY, 
                            max: dataRanges['2d'].maxY + paddingY 
                            // ----------------------
                        }
                    }
            });
            document.getElementById('vis-2d').style.backgroundColor = bgColor;
        }

        /**
         * åˆå§‹åŒ– 3D Three.js åœºæ™¯ (åªåˆå§‹åŒ–åœºæ™¯å’Œæ§åˆ¶å™¨)
         */
        function init3DScene() {
            const container = document.getElementById('vis-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            const canvas3d = document.getElementById('vis-3d');

            // 1. åœºæ™¯ (Scene)
            scene = new THREE.Scene();
            scene.background = new THREE.Color(colorConfig.backgroundColor.replace('#', '0x'));

            // 2. ç›¸æœº (Camera)
            const center3D = {
                x: (dataRanges['3d'].minX + dataRanges['3d'].maxX) / 2,
                y: (dataRanges['3d'].minY + dataRanges['3d'].maxY) / 2,
                z: (dataRanges['3d'].minZ + dataRanges['3d'].maxZ) / 2,
            };
            const maxSize = Math.max(
                dataRanges['3d'].maxX - dataRanges['3d'].minX,
                dataRanges['3d'].maxY - dataRanges['3d'].minY,
                dataRanges['3d'].maxZ - dataRanges['3d'].minZ
            );
            const cameraDistance = maxSize * 1.5 || 5000; // ç¡®ä¿ç›¸æœºè¶³å¤Ÿè¿œ

            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, cameraDistance * 20);
            
            // å°†ç›¸æœºä½ç½®è®¾å®šåœ¨æ•°æ®ä¸­å¿ƒç‚¹åç§»ä¸€å®šè·ç¦»
            camera.position.set(
                center3D.x + cameraDistance, 
                center3D.y + cameraDistance, 
                center3D.z + cameraDistance
            ); 
            // ç¡®ä¿ controls çš„ target æ˜¯æ•°æ®ä¸­å¿ƒç‚¹
            controls.target.set(center3D.x, center3D.y, center3D.z);

            // 3. æ¸²æŸ“å™¨ (Renderer)
            renderer = new THREE.WebGLRenderer({ canvas: canvas3d, antialias: true });
            renderer.setSize(width, height);
            
            // 4. äº¤äº’æ§åˆ¶ (Controls)
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; 
            controls.dampingFactor = 0.05;

            // 5. å…‰æº
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(100, 100, 100);
            scene.add(directionalLight);

            // 6. åæ ‡è½´ (Axes Helper)
            const axesHelperSize = maxSize * 1.5 || 5000;
            const axesHelper = new THREE.AxesHelper(axesHelperSize); 
            axesHelper.position.set(center3D.x, center3D.y, center3D.z); // æ”¾ç½®åœ¨æ•°æ®ä¸­å¿ƒ
            axesHelper.name = 'Axes';
            scene.add(axesHelper);

            // 7. æ¸²æŸ“å¾ªç¯ (Animate Loop)
            function animate() {
                animationFrameId = requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
        }


        /**
         * ä¿®å¤ (2)ï¼šæ ¹æ®è¿›åº¦æ›´æ–° 3D è½¨è¿¹å’Œå½“å‰ç‚¹
         */
        function update3DPath(data, frameIndex) {
            // æ¸…ç†æ—§çš„è½¨è¿¹å’Œç‚¹
            const oldLine = scene.getObjectByName('TrajectoryLine');
            const oldSphere = scene.getObjectByName('CurrentPoint');
            
            if (oldLine) scene.remove(oldLine);
            if (oldSphere) scene.remove(oldSphere);
            
            if (data.length === 0) return;

            // 1. è½¨è¿¹çº¿å’Œç‚¹äº‘åªæ¸²æŸ“åˆ°å½“å‰å¸§
            const currentPath = data.slice(0, frameIndex + 1);
            const pathPoints = currentPath.map(d => new THREE.Vector3(d['x_3d(m)'], d['y_3d(m)'], d['z_3d(m)']));
            const geometry = new THREE.BufferGeometry().setFromPoints(pathPoints);
            const opacity = parseFloat(document.getElementById('opacity-slider').value);
            const pointSize = parseFloat(document.getElementById('size-slider').value) * 0.5;

            // ç»˜åˆ¶ 3D è½¨è¿¹çº¿
            const lineMaterial = new THREE.LineBasicMaterial({ 
                color: new THREE.Color(colorConfig.historyLine),
                transparent: true,
                opacity: opacity
            });
            line3D = new THREE.Line(geometry, lineMaterial);
            line3D.name = 'TrajectoryLine';
            scene.add(line3D);

            // ç»˜åˆ¶ 3D çƒ­åŠ›ç‚¹ (Point Cloud)
            const pointsMaterial = new THREE.PointsMaterial({
                color: new THREE.Color(colorConfig.historyLine), 
                size: pointSize, 
                transparent: true,
                opacity: opacity,
                sizeAttenuation: true
            });
            pointsCloud3D = new THREE.Points(geometry, pointsMaterial);
            pointsCloud3D.name = 'TrajectoryPoints';
            scene.add(pointsCloud3D);


            // 2. ç»˜åˆ¶å½“å‰é«˜äº®ç‚¹ (Sphere)
            const currentPointData = data[frameIndex];
            if (currentPointData) {
                const radius = parseFloat(document.getElementById('size-slider').value) * 1.5; 
                const sphereGeometry = new THREE.SphereGeometry(radius, 16, 16); 
                const sphereMaterial = new THREE.MeshBasicMaterial({ color: new THREE.Color(colorConfig.currentPoint) });
                
                currentSphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
                currentSphere.position.set(currentPointData['x_3d(m)'], currentPointData['y_3d(m)'], currentPointData['z_3d(m)']);
                currentSphere.name = 'CurrentPoint';
                scene.add(currentSphere);
            }

            // ä¼˜åŒ–ï¼šåªæœ‰åœ¨æ’­æ”¾æˆ–æ‰‹åŠ¨æ‹–åŠ¨æ—¶ï¼Œæ‰å¼ºåˆ¶æ¸²æŸ“
            renderer.render(scene, camera);
        }

        /**
         * æ›´æ–° 2D è½¨è¿¹å’Œå½“å‰ç‚¹
         */
        function update2DChart() {
            if (!chart2d || cleanData.length === 0) return;

            const currentPath = cleanData.slice(0, currentFrameIndex + 1);
            
            // 1. å†å²è½¨è¿¹çº¿ (ä»å¤´åˆ°å½“å‰å¸§)
            const historyData = currentPath.map(d => ({ x: d.x_2d, y: d.y_2d }));
            chart2d.data.datasets[1].data = historyData;
            chart2d.data.datasets[1].borderColor = colorConfig.historyLine;
            chart2d.data.datasets[1].backgroundColor = colorConfig.historyLine;


            // 2. å½“å‰ç‚¹ (åªæ˜¾ç¤ºä¸€ä¸ªç‚¹)
            const currentPoint = cleanData[currentFrameIndex];
            chart2d.data.datasets[0].data = currentPoint ? [{ x: currentPoint.x_2d, y: currentPoint.y_2d }] : [];
            chart2d.data.datasets[0].pointRadius = parseInt(document.getElementById('size-slider').value);
            chart2d.data.datasets[0].backgroundColor = colorConfig.currentPoint; 
            
            chart2d.update('none'); 
        }

        /**
         * æ›´æ–°æ‰€æœ‰å¯è§†åŒ–å†…å®¹ (2D å’Œ 3D)
         */
        function updateVisualizations() {
            if (cleanData.length === 0) return;
            
            // é¢œè‰²æ›´æ–°ï¼šå½“åˆ‡æ¢æ¨¡å¼æˆ–é…ç½®æ”¹å˜æ—¶ï¼Œæ›´æ–°åœºæ™¯èƒŒæ™¯è‰²
            if (currentVisMode === '3d' && scene) {
                 scene.background = new THREE.Color(colorConfig.backgroundColor.replace('#', '0x'));
            } else if (currentVisMode === '2d' && chart2d) {
                document.getElementById('vis-2d').style.backgroundColor = colorConfig.backgroundColor;
                chart2d.options.backgroundColor = colorConfig.backgroundColor;
            }

            if (currentVisMode === '2d') {
                update2DChart();
            } else {
                if (!scene) init3DScene();
                update3DPath(cleanData, currentFrameIndex);
            }
        }
        
        // =================================================================
        // UI å’Œæ§åˆ¶å‡½æ•°
        // =================================================================

        /**
         * æ›´æ–°é¢œè‰²é…ç½®å¯¹è±¡
         */
        function updateColorConfig() {
            colorConfig.historyLine = document.getElementById('color-history').value;
            colorConfig.currentPoint = document.getElementById('color-current').value;
            colorConfig.backgroundColor = document.getElementById('color-background').value;
            updateVisualizations();
        }

        /**
         * é‡ç½®æ’­æ”¾çŠ¶æ€
         */
        function resetPlayback(data) {
            stopPlayback();
            currentFrameIndex = 0;
            const maxFrame = data.length > 0 ? data.length - 1 : 0;
            
            document.getElementById('frame-slider').max = maxFrame;
            document.getElementById('frame-slider').value = 0;
            document.getElementById('frame-max').textContent = maxFrame;
            document.getElementById('frame-val').textContent = 0;
            document.getElementById('playback-controls').style.display = 'block';
            
            // å¯ç”¨å¯¼å‡ºæŒ‰é’®
            document.getElementById('export-image-btn').disabled = false;
            document.getElementById('export-gif-btn').disabled = false;

            updateVisualizations();
        }

        /**
         * å¼€å§‹åŠ¨æ€æ’­æ”¾
         */
        function startPlayback() {
            if (playInterval) return;

            const intervalTime = baseInterval / playbackSpeed;
            const totalFrames = cleanData.length - 1;
            
            document.getElementById('play-btn').innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM7.25 7a.75.75 0 00-1.5 0v6a.75.75 0 001.5 0V7zM11.25 7a.75.75 0 00-1.5 0v6a.75.75 0 001.5 0V7zM15.25 7a.75.75 0 00-1.5 0v6a.75.75 0 001.5 0V7z"></path></svg><span class="ml-2">æš‚åœ</span>';

            playInterval = setInterval(() => {
                if (currentFrameIndex >= totalFrames) {
                    stopPlayback();
                    // æ’­æ”¾ç»“æŸåï¼ŒæŒ‰é’®åˆ‡å›æ’­æ”¾çŠ¶æ€
                    document.getElementById('play-btn').innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg><span class="ml-2">æ’­æ”¾</span>';
                    return;
                }
                
                currentFrameIndex++;
                document.getElementById('frame-slider').value = currentFrameIndex;
                document.getElementById('frame-val').textContent = currentFrameIndex;
                updateVisualizations();

            }, intervalTime);
        }

        /**
         * åœæ­¢åŠ¨æ€æ’­æ”¾
         */
        function stopPlayback() {
            clearInterval(playInterval);
            playInterval = null;
            document.getElementById('play-btn').innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg><span class="ml-2">æ’­æ”¾</span>';
        }

        // =================================================================
        // å¯¼å‡ºåŠŸèƒ½å®ç°
        // =================================================================

        /**
         * å¯¼å‡ºå½“å‰å¸§ä¸ºå›¾ç‰‡ (PNG)
         */
        function exportImage() {
            let canvas;
            if (currentVisMode === '2d' && chart2d) {
                // 2D: ä½¿ç”¨ Chart.js çš„ base64 æ–¹æ³•
                const image = chart2d.toBase64Image('image/png');
                downloadURI(image, 'trajectory_2d_frame_' + currentFrameIndex + '.png');
            } else if (currentVisMode === '3d' && renderer) {
                // 3D: ä½¿ç”¨ Three.js æ¸²æŸ“å™¨çš„ toDataURL æ–¹æ³•
                renderer.render(scene, camera);
                const image = renderer.domElement.toDataURL('image/png');
                downloadURI(image, 'trajectory_3d_frame_' + currentFrameIndex + '.png');
            } else {
                alert('è¯·å…ˆåŠ è½½æ•°æ®å¹¶åˆ‡æ¢åˆ° 2D æˆ– 3D æ¨¡å¼ã€‚');
            }
        }

        /**
         * å¯¼å‡ºæ•´ä¸ªåŠ¨ç”»ä¸º GIF (ä½¿ç”¨ gif.js)
         */
        function exportGIF() {
            if (cleanData.length === 0) {
                alert('è¯·å…ˆåŠ è½½æ•°æ®ã€‚');
                return;
            }

            // é”å®š UIï¼Œæ˜¾ç¤ºè¿›åº¦æ¡
            document.getElementById('gif-progress').classList.remove('hidden');
            document.getElementById('export-gif-btn').disabled = true;
            document.getElementById('export-image-btn').disabled = true;

            const originalFrameIndex = currentFrameIndex;
            const totalFrames = cleanData.length;
            const canvasElement = (currentVisMode === '2d') ? document.getElementById('vis-2d') : document.getElementById('vis-3d');
            const gif = new GIF({
                workers: 4, // ä½¿ç”¨å¤šä¸ª worker æé«˜ç”Ÿæˆé€Ÿåº¦
                quality: 10,
                width: canvasElement.clientWidth,
                height: canvasElement.clientHeight
            });

            // ç›‘å¬è¿›åº¦
            gif.on('progress', function(p) {
                const percent = Math.round(p * 100);
                document.getElementById('gif-progress-bar').style.width = percent + '%';
                document.getElementById('gif-progress-text').textContent = percent + '%';
            });

            // ç›‘å¬ç”Ÿæˆå®Œæˆ
            gif.on('finished', function(blob) {
                document.getElementById('gif-progress').classList.add('hidden');
                document.getElementById('export-gif-btn').disabled = false;
                document.getElementById('export-image-btn').disabled = false;
                
                // æ¢å¤æ’­æ”¾çŠ¶æ€
                currentFrameIndex = originalFrameIndex;
                document.getElementById('frame-slider').value = originalFrameIndex;
                document.getElementById('frame-val').textContent = originalFrameIndex;
                updateVisualizations();

                // ä¸‹è½½ GIF
                downloadURI(URL.createObjectURL(blob), 'trajectory_animation.gif');
            });

            // é€å¸§æ·»åŠ å›¾ç‰‡åˆ° GIF
            const frameRate = baseInterval / playbackSpeed;
            for (let i = 0; i < totalFrames; i++) {
                // ä¸´æ—¶æ›´æ–°å½“å‰å¸§
                currentFrameIndex = i;
                updateVisualizations();

                // å¼ºåˆ¶ç­‰å¾…æ¸²æŸ“
                if (currentVisMode === '3d') {
                    renderer.render(scene, camera);
                } else if (currentVisMode === '2d' && chart2d) {
                    chart2d.update('none');
                }
                
                // æ·»åŠ åˆ° GIF (ä½¿ç”¨ canvas å…ƒç´ çš„å‰¯æœ¬)
                gif.addFrame(canvasElement, { delay: frameRate, copy: true });
            }

            // å¼€å§‹ç”Ÿæˆ
            gif.render();
        }


        /**
         * è¾…åŠ©å‡½æ•°ï¼šè§¦å‘ä¸‹è½½
         */
        function downloadURI(uri, name) {
            const link = document.createElement('a');
            link.download = name;
            link.href = uri;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // =================================================================
        // äº‹ä»¶ç›‘å¬å™¨
        // =================================================================

        document.addEventListener('DOMContentLoaded', () => {
            
            // ç¡®ä¿ colorConfig å˜é‡åœ¨ DOM åŠ è½½ååˆå§‹åŒ–
            if (!document.getElementById('color-history')) {
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œä¸”å…ƒç´ ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨åˆå§‹åŒ–ä»¥é˜²å´©æºƒ
                colorConfig = { historyLine: '#3b82f6', currentPoint: '#ffff00', backgroundColor: '#27272a' };
            } else {
                updateColorConfig();
            }

            // 1. æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            document.getElementById('csv-file').addEventListener('change', handleFileUpload);
            
            // 2. æ¨¡å¼åˆ‡æ¢äº‹ä»¶
            document.getElementById('vis-mode').addEventListener('change', (e) => {
                switchVisualizationMode(e.target.value);
            });
            
            // 3. æ’­æ”¾/æš‚åœæŒ‰é’®
            document.getElementById('play-btn').addEventListener('click', () => {
                if (playInterval) {
                    stopPlayback();
                } else {
                    if (currentFrameIndex >= cleanData.length - 1) {
                        currentFrameIndex = 0;
                    }
                    startPlayback();
                }
            });

            // 4. è¿›åº¦æ¡æ»‘å—
            document.getElementById('frame-slider').addEventListener('input', (e) => {
                stopPlayback();
                currentFrameIndex = parseInt(e.target.value);
                document.getElementById('frame-val').textContent = currentFrameIndex;
                updateVisualizations();
            });

            // 5. é€Ÿåº¦è°ƒæ•´æ»‘å— (å…³é”®ä¿®å¤: é‡æ–°å¯åŠ¨å®šæ—¶å™¨)
            document.getElementById('speed-slider').addEventListener('input', (e) => {
                playbackSpeed = parseFloat(e.target.value);
                document.getElementById('speed-val').textContent = playbackSpeed.toFixed(1);
                if (playInterval) {
                    clearInterval(playInterval);
                    startPlayback(); 
                }
            });

            // 6. å°ºå¯¸å’Œä¸é€æ˜åº¦æ»‘å—
            document.getElementById('size-slider').addEventListener('input', (e) => {
                document.getElementById('size-val').textContent = e.target.value;
                updateVisualizations();
            });

            document.getElementById('opacity-slider').addEventListener('input', (e) => {
                document.getElementById('opacity-val').textContent = e.target.value;
                updateVisualizations();
            });

            // 7. é¢œè‰²é€‰æ‹©å™¨ (æ–°åŠŸèƒ½: ç”¨æˆ·å‰ç«¯é…ç½®é¢œè‰²)
            document.getElementById('color-history').addEventListener('input', updateColorConfig);
            document.getElementById('color-current').addEventListener('input', updateColorConfig);
            document.getElementById('color-background').addEventListener('input', updateColorConfig);

            // 8. å¯¼å‡ºæŒ‰é’®
            document.getElementById('export-image-btn').addEventListener('click', exportImage);
            document.getElementById('export-gif-btn').addEventListener('click', exportGIF);


            // 9. çª—å£å°ºå¯¸è°ƒæ•´ (å“åº”å¼å¸ƒå±€)
            window.addEventListener('resize', onWindowResize);
            
            // åˆå§‹åŒ–é»˜è®¤æ¨¡å¼
            switchVisualizationMode('2d');
        });

        /**
         * çª—å£å°ºå¯¸è°ƒæ•´å‡½æ•° (ç”¨äº 2D å’Œ 3D)
         */
        function onWindowResize() {
            const container = document.getElementById('vis-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // 2D Resize
            if (chart2d) {
                chart2d.resize();
            }

            // 3D Resize
            if (camera && renderer) {
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }
        }

        /**
         * å¤„ç†æ–‡ä»¶ä¸Šä¼  (æ ¸å¿ƒè§£æé€»è¾‘)
         */
        function handleFileUpload(event) {
            const file = event.target.files[0];
            const status = document.getElementById('status');
            const progressDiv = document.getElementById('progress-container');

            if (!file) return;

            status.textContent = 'â–¶ï¸ æ­£åœ¨è§£æ CSV æ–‡ä»¶...';
            progressDiv.classList.remove('hidden');

            // 1. é‡ç½®çŠ¶æ€
            stopPlayback();
            allData = [];
            cleanData = [];
            
            // 2. ä½¿ç”¨ Papa Parse è§£æ CSV
            Papa.parse(file, {
                header: true,
                skipEmptyLines: 'greedy',
                dynamicTyping: true, 
                worker: true, 
                
                complete: (results, file) => {
                    progressDiv.classList.add('hidden');
                    
                    if (results.data.length === 0) {
                        status.textContent = 'âŒ CSV è§£æå¤±è´¥ï¼šæ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯ã€‚';
                        return;
                    }
                    
                    allData = results.data;
                    cleanData = processAndCleanData(allData);

                    if (cleanData.length === 0) {
                        status.textContent = 'âŒ CSV è§£æå¤±è´¥ï¼šæœ‰æ•ˆæ•°æ®ç‚¹ä¸è¶³ï¼Œè¯·æ£€æŸ¥åˆ—åå’Œæ•°å€¼ã€‚';
                        return;
                    }

                    // 4. æ›´æ–° UI å’Œå¯è§†åŒ–
                    calculateMotionMetrics(cleanData);
                    // --- è°ƒç”¨æ–°å‡½æ•°è®¡ç®—æ•°æ®èŒƒå›´ (æ–°æ·»åŠ ) ---
                    dataRanges = calculateDataRanges(cleanData);
                    // ----------------------------------------
                    resetPlayback(cleanData); 
                    
                    status.textContent = `âœ… æ•°æ®åŠ è½½æˆåŠŸï¼å…± ${cleanData.length} ä¸ªæœ‰æ•ˆæ•°æ®ç‚¹ã€‚`;
                },
                error: (error, file) => {
                    progressDiv.classList.add('hidden');
                    status.textContent = `âŒ CSV è§£æé”™è¯¯: ${error.message}`;
                }
            });
        }
    </script>
</body>
</html>
